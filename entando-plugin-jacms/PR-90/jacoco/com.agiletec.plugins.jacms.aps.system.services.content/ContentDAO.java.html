<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContentDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Plugin: CMS</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.plugins.jacms.aps.system.services.content</a> &gt; <span class="el_source">ContentDAO.java</span></div><h1>ContentDAO.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package com.agiletec.plugins.jacms.aps.system.services.content;

import com.agiletec.aps.system.SystemConstants;
import java.sql.BatchUpdateException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;

import com.agiletec.aps.system.common.entity.AbstractEntityDAO;
import com.agiletec.aps.system.common.entity.model.ApsEntityRecord;
import com.agiletec.aps.system.common.entity.model.IApsEntity;
import com.agiletec.aps.system.common.entity.model.attribute.AttributeInterface;
import com.agiletec.aps.system.common.util.EntityAttributeIterator;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.category.Category;
import com.agiletec.aps.system.services.category.ICategoryManager;
import com.agiletec.aps.util.DateConverter;
import com.agiletec.plugins.jacms.aps.system.services.content.model.CmsAttributeReference;
import com.agiletec.plugins.jacms.aps.system.services.content.model.Content;
import com.agiletec.plugins.jacms.aps.system.services.content.model.ContentRecordVO;
import com.agiletec.plugins.jacms.aps.system.services.content.model.attribute.IReferenceableAttribute;
import org.apache.commons.lang3.StringUtils;

/**
 * DAO class for objects of type content.
 * 
 * @author M.Diana - E.Santoboni - S.Didaci
 */
<span class="fc" id="L52">public class ContentDAO extends AbstractEntityDAO implements IContentDAO {</span>

<span class="fc" id="L54">	private static final EntLogger _logger = EntLogFactory.getSanitizedLogger(ContentDAO.class);</span>

	private static final String DELETE_CONTENT = &quot;DELETE FROM contents WHERE contentid = ? &quot;;

	private static final String DELETE_CONTENT_REL_RECORD = &quot;DELETE FROM contentrelations WHERE contentid = ? &quot;;

	private static final String DELETE_WORK_CONTENT_REL_RECORD = &quot;DELETE FROM workcontentrelations WHERE contentid = ? &quot;;

	private static final String ADD_CONTENT_SEARCH_RECORD = &quot;INSERT INTO contentsearch (contentid, attrname, textvalue, datevalue, numvalue, langcode) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String DELETE_CONTENT_SEARCH_RECORD = &quot;DELETE FROM contentsearch WHERE contentid = ? &quot;;

	private static final String ADD_WORK_CONTENT_SEARCH_RECORD = &quot;INSERT INTO workcontentsearch (contentid, attrname, textvalue, datevalue, numvalue, langcode) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String DELETE_WORK_CONTENT_SEARCH_RECORD = &quot;DELETE FROM workcontentsearch WHERE contentid = ? &quot;;

	private static final String ADD_CONTENT_REL_RECORD = &quot;INSERT INTO contentrelations &quot;
			+ &quot;(contentid, refpage, refcontent, refresource, refcategory, refgroup) VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String ADD_WORK_CONTENT_REL_RECORD = &quot;INSERT INTO workcontentrelations (contentid, refcategory) VALUES ( ? , ? )&quot;;

	private static final String LOAD_CONTENTS_ID_MAIN_BLOCK = &quot;SELECT DISTINCT contents.contentid FROM contents &quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_PAGE = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refpage = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_CONTENT = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refcontent = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_GROUP = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refgroup = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_RESOURCE = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refresource = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_CATEGORY = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refcategory = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_CONTENTS_VO_MAIN_BLOCK = &quot;SELECT contents.contentid, contents.contenttype, contents.descr, &quot;
            + &quot;contents.status, contents.workxml, contents.created, contents.lastmodified, contents.onlinexml, contents.published, &quot;
            + &quot;contents.sync, contents.maingroup, contents.currentversion, contents.firsteditor, contents.lasteditor, contents.restriction FROM contents &quot;;

	private static final String LOAD_CONTENT_VO = LOAD_CONTENTS_VO_MAIN_BLOCK + &quot; WHERE contents.contentid = ? &quot;;

	private static final String LOAD_REFERENCED_WORK_CONTENTS_FOR_CATEGORY = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN workcontentrelations ON contents.contentid = workcontentrelations.contentid WHERE refcategory = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String ADD_CONTENT = &quot;INSERT INTO contents (contentid, contenttype, descr, status, workxml, &quot;
			+ &quot;created, lastmodified, sync, maingroup, currentversion, firsteditor, lasteditor, restriction) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ?)&quot;;

	private static final String INSERT_ONLINE_CONTENT = &quot;UPDATE contents SET contenttype = ? , descr = ? , status = ? , &quot;
			+ &quot;workxml = ? , lastmodified = ? , onlinexml = ? , published = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , &quot;
			+ &quot;restriction = ? WHERE contentid = ? &quot;;

	private static final String INSERT_ONLINE_CONTENT_WITHOUT_DATE = &quot;UPDATE contents SET contenttype = ? , descr = ? , status = ? , &quot;
			+ &quot;workxml = ? , onlinexml = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String REMOVE_ONLINE_CONTENT = &quot;UPDATE contents SET onlinexml = ? , published = ? , sync = ? , &quot;
            + &quot;status = ? , workxml = ? , lastmodified = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String REMOVE_ONLINE_CONTENT_WITHOUT_DATE = &quot;UPDATE contents SET onlinexml = ? , published = ? , sync = ? , &quot;
            + &quot;status = ? , workxml = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String UPDATE_CONTENT = &quot;UPDATE contents SET contenttype = ? , descr = ? , status = ? , &quot;
			+ &quot;workxml = ? , sync = ? , lastmodified = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? &quot; + &quot;WHERE contentid = ? &quot;;

	private static final String UPDATE_CONTENT_WITHOUT_DATE = &quot;UPDATE contents SET contenttype = ? , descr = ? , status = ? , &quot;
			+ &quot;workxml = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? &quot; + &quot;WHERE contentid = ? &quot;;

	private static final String LOAD_ALL_CONTENTS_ID = &quot;SELECT contentid FROM contents&quot;;

	private static final String ADD_ATTRIBUTE_ROLE_RECORD = &quot;INSERT INTO contentattributeroles (contentid, attrname, rolename) VALUES ( ? , ? , ? )&quot;;

	private static final String DELETE_ATTRIBUTE_ROLE_RECORD = &quot;DELETE FROM contentattributeroles WHERE contentid = ? &quot;;

	private static final String ADD_WORK_ATTRIBUTE_ROLE_RECORD = &quot;INSERT INTO workcontentattributeroles (contentid, attrname, rolename) VALUES ( ? , ? , ? )&quot;;

	private static final String DELETE_WORK_ATTRIBUTE_ROLE_RECORD = &quot;DELETE FROM workcontentattributeroles WHERE contentid = ? &quot;;
    
	private static final String COUNT_OFFLINE_CONTENTS = 
            &quot;SELECT count(contents.contentid) from contents WHERE contents.sync = 0 and onlinexml is null&quot;;

	private static final String COUNT_ONLINE_CONTENTS = 
            &quot;SELECT count(contentid) from contents WHERE contents.sync = 1&quot;;

	private static final String COUNT_ONLINE_CONTENTS_WITH_DIFFS = 
            &quot;SELECT count(contents.contentid) from contents WHERE contents.sync = 0 and onlinexml is not null&quot;;
    
    private static final String LOAD_LAST_MODIFIED_DATE  = &quot;SELECT MAX(lastmodified) FROM contents&quot;;
    
    private ICategoryManager categoryManager;

	@Override
	protected String getLoadEntityRecordQuery() {
<span class="fc" id="L157">		return LOAD_CONTENT_VO;</span>
	}

	@Override
	protected ApsEntityRecord createEntityRecord(ResultSet res) throws Throwable {
<span class="fc" id="L162">        ContentRecordVO contentVo = new ContentRecordVO();</span>
<span class="fc" id="L163">		contentVo.setId(res.getString(&quot;contentid&quot;));</span>
<span class="fc" id="L164">		contentVo.setTypeCode(res.getString(&quot;contenttype&quot;));</span>
<span class="fc" id="L165">		contentVo.setDescription(res.getString(&quot;descr&quot;));</span>
<span class="fc" id="L166">		contentVo.setStatus(res.getString(&quot;status&quot;));</span>
<span class="fc" id="L167">		String xmlWork = res.getString(&quot;workxml&quot;);</span>
<span class="fc" id="L168">		contentVo.setCreate(DateConverter.parseDate(res.getString(&quot;created&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L169">		contentVo.setModify(DateConverter.parseDate(res.getString(&quot;lastmodified&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L170">		contentVo.setPublish(DateConverter.parseDate(res.getString(&quot;published&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L171">		String xmlOnLine = res.getString(&quot;onlinexml&quot;);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">		contentVo.setOnLine(!StringUtils.isBlank(xmlOnLine));</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">		contentVo.setSync(res.getInt(&quot;sync&quot;) == 1);</span>
<span class="fc" id="L174">		contentVo.setMainGroupCode(res.getString(&quot;maingroup&quot;));</span>
<span class="fc" id="L175">		contentVo.setXmlWork(xmlWork);</span>
<span class="fc" id="L176">		contentVo.setXmlOnLine(xmlOnLine);</span>
<span class="fc" id="L177">		contentVo.setVersion(res.getString(&quot;currentversion&quot;));</span>
<span class="fc" id="L178">		contentVo.setFirstEditor(res.getString(&quot;firsteditor&quot;));</span>
<span class="fc" id="L179">		contentVo.setLastEditor(res.getString(&quot;lasteditor&quot;));</span>
<span class="fc" id="L180">		contentVo.setRestriction(res.getString(&quot;restriction&quot;));</span>
<span class="fc" id="L181">		return contentVo;</span>
	}

	@Override
	protected void executeAddEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L186">		super.executeAddEntity(entity, conn);</span>
<span class="fc" id="L187">		this.addWorkContentRelationsRecord((Content) entity, conn);</span>
<span class="fc" id="L188">	}</span>

	@Override
	protected String getAddEntityRecordQuery() {
<span class="fc" id="L192">		return ADD_CONTENT;</span>
	}
    
	@Override
	protected void buildAddEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L197">		Content content = (Content) entity;</span>
<span class="fc" id="L198">		stat.setString(1, content.getId());</span>
<span class="fc" id="L199">		stat.setString(2, content.getTypeCode());</span>
<span class="fc" id="L200">		stat.setString(3, content.getDescription());</span>
<span class="fc" id="L201">		stat.setString(4, content.getStatus());</span>
<span class="fc" id="L202">		stat.setString(5, content.getXML());</span>
<span class="fc" id="L203">		String currentDate = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="fc" id="L204">		stat.setString(6, currentDate);</span>
<span class="fc" id="L205">		stat.setString(7, currentDate);</span>
<span class="fc" id="L206">		stat.setInt(8, 0);</span>
<span class="fc" id="L207">		stat.setString(9, content.getMainGroup());</span>
<span class="fc" id="L208">		stat.setString(10, content.getVersion());</span>
<span class="fc" id="L209">		stat.setString(11, content.getFirstEditor());</span>
<span class="fc" id="L210">		stat.setString(12, content.getLastEditor());</span>
<span class="fc" id="L211">		stat.setString(13, content.getRestriction());</span>
<span class="fc" id="L212">	}</span>

	@Override
	public void updateContent(Content content, boolean updateDate) {
<span class="fc" id="L216">		Connection conn = null;</span>
		try {
<span class="fc" id="L218">			conn = this.getConnection();</span>
<span class="fc" id="L219">			conn.setAutoCommit(false);</span>
<span class="fc" id="L220">			this.executeUpdateContent(content, updateDate, conn);</span>
<span class="fc" id="L221">			conn.commit();</span>
<span class="nc" id="L222">		} catch (Throwable t) {</span>
<span class="nc" id="L223">			this.executeRollback(conn);</span>
<span class="nc" id="L224">			_logger.error(&quot;Error updating content&quot;, t);</span>
<span class="nc" id="L225">			throw new RuntimeException(&quot;Error updating content&quot;, t);</span>
		} finally {
<span class="fc" id="L227">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L229">	}</span>

	protected void executeUpdateContent(Content content, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L232">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L234">			this.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L235">			this.deleteRecordsByEntityId(content.getId(), this.getRemovingSearchRecordQuery(), conn);</span>
<span class="fc" id="L236">			this.deleteRecordsByEntityId(content.getId(), this.getRemovingAttributeRoleRecordQuery(), conn);</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L238">				stat = conn.prepareStatement(this.getUpdateEntityRecordQuery());</span>
			} else {
<span class="nc" id="L240">				stat = conn.prepareStatement(this.getUpdateEntityRecordQueryWithoutDate());</span>
			}
<span class="fc" id="L242">			this.buildUpdateEntityStatement(content, updateDate, stat);</span>
<span class="fc" id="L243">			stat.executeUpdate();</span>
<span class="fc" id="L244">			this.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L245">			this.addEntityAttributeRoleRecord(content.getId(), content, conn);</span>
<span class="fc" id="L246">			this.addWorkContentRelationsRecord(content, conn);</span>
<span class="nc" id="L247">		} catch (Throwable t) {</span>
<span class="nc" id="L248">			throw t;</span>
		} finally {
<span class="fc" id="L250">			this.closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L252">	}</span>

	@Override
	protected void executeUpdateEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L256">		this.deleteRecordsByEntityId(entity.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L257">		super.executeUpdateEntity(entity, conn);</span>
<span class="fc" id="L258">		this.addWorkContentRelationsRecord((Content) entity, conn);</span>
<span class="fc" id="L259">	}</span>

	@Override
	protected String getUpdateEntityRecordQuery() {
<span class="fc" id="L263">		return UPDATE_CONTENT;</span>
	}

	protected String getUpdateEntityRecordQueryWithoutDate() {
<span class="nc" id="L267">		return UPDATE_CONTENT_WITHOUT_DATE;</span>
	}

	@Override
	protected void buildUpdateEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L272">		this.buildUpdateEntityStatement(entity, true, stat);</span>
<span class="fc" id="L273">	}</span>

	protected void buildUpdateEntityStatement(IApsEntity entity, boolean updateDate, PreparedStatement stat) throws Throwable {
<span class="fc" id="L276">		Content content = (Content) entity;</span>
<span class="fc" id="L277">		int index = 1;</span>
<span class="fc" id="L278">		stat.setString(index++, content.getTypeCode());</span>
<span class="fc" id="L279">		stat.setString(index++, content.getDescription());</span>
<span class="fc" id="L280">		stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L281">		stat.setString(index++, content.getXML());</span>
<span class="fc" id="L282">		stat.setInt(index++, 0);</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">		if (updateDate) {</span>
<span class="fc" id="L284">			stat.setString(index++, DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
		}
<span class="fc" id="L286">		stat.setString(index++, content.getMainGroup());</span>
<span class="fc" id="L287">		stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L288">		stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L289">		stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L290">		stat.setString(index++, content.getId());</span>
<span class="fc" id="L291">	}</span>

	/**
	 * This publishes a content.
	 * 
	 * @param content
	 * the content to publish.
	 */
	@Override
	public void insertOnLineContent(Content content) {
<span class="fc" id="L301">		Connection conn = null;</span>
		try {
<span class="fc" id="L303">			conn = this.getConnection();</span>
<span class="fc" id="L304">			conn.setAutoCommit(false);</span>
<span class="fc" id="L305">			this.executeInsertOnLineContent(content, conn);</span>
<span class="fc" id="L306">			conn.commit();</span>
<span class="nc" id="L307">		} catch (Throwable t) {</span>
<span class="nc" id="L308">			this.executeRollback(conn);</span>
<span class="nc" id="L309">			_logger.error(&quot;Error publish content {} &quot;, content.getId(), t);</span>
<span class="nc" id="L310">			throw new RuntimeException(&quot;Error publish content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L312">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L314">	}</span>

	protected void executeInsertOnLineContent(Content content, Connection conn) throws Throwable {
<span class="fc" id="L317">		this.executeInsertOnLineContent(content, true, conn);</span>
<span class="fc" id="L318">	}</span>

	protected void executeInsertOnLineContent(Content content, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L321">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L322">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L323">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L324">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L325">		super.deleteEntitySearchRecord(content.getId(), conn);</span>
<span class="fc" id="L326">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L327">		this.updateContentRecordForInsertOnLine(content, updateDate, conn);</span>
<span class="fc" id="L328">		this.addPublicContentSearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L329">		super.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L330">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L331">		this.addWorkContentRelationsRecord(content, conn);</span>
<span class="fc" id="L332">		this.addContentRelationsRecord(content, conn);</span>
<span class="fc" id="L333">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L334">	}</span>

	@Deprecated
	protected void deletePublicContentSearchRecord(String id, Connection conn) throws EntException {
<span class="nc" id="L338">		super.deleteRecordsByEntityId(id, DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="nc" id="L339">	}</span>

	protected void addPublicContentSearchRecord(String id, IApsEntity entity, Connection conn) throws EntException {
<span class="fc" id="L342">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L344">			stat = conn.prepareStatement(ADD_CONTENT_SEARCH_RECORD);</span>
<span class="fc" id="L345">			this.addEntitySearchRecord(id, entity, stat);</span>
<span class="nc" id="L346">		} catch (Throwable t) {</span>
<span class="nc" id="L347">			_logger.error(&quot;Error on adding public content search records&quot;, t);</span>
<span class="nc" id="L348">			throw new RuntimeException(&quot;Error on adding public content search records&quot;, t);</span>
		} finally {
<span class="fc" id="L350">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L352">	}</span>

	protected void updateContentRecordForInsertOnLine(Content content, Connection conn) throws EntException {
<span class="nc" id="L355">		this.updateContentRecordForInsertOnLine(content, true, conn);</span>
<span class="nc" id="L356">	}</span>

	protected void updateContentRecordForInsertOnLine(Content content, boolean updateDate, Connection conn) throws EntException {
<span class="fc" id="L359">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L361">			int index = 1;</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L363">				stat = conn.prepareStatement(INSERT_ONLINE_CONTENT);</span>
			} else {
<span class="nc" id="L365">				stat = conn.prepareStatement(INSERT_ONLINE_CONTENT_WITHOUT_DATE);</span>
			}
<span class="fc" id="L367">			stat.setString(index++, content.getTypeCode());</span>
<span class="fc" id="L368">			stat.setString(index++, content.getDescription());</span>
<span class="fc" id="L369">			stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L370">			String xml = content.getXML();</span>
<span class="fc" id="L371">			stat.setString(index++, xml);</span>
<span class="fc" id="L372">            String cuttentDateString = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L374">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L376">			stat.setString(index++, xml);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L378">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L380">            stat.setInt(index++, 1);</span>
<span class="fc" id="L381">			stat.setString(index++, content.getMainGroup());</span>
<span class="fc" id="L382">			stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L383">			stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L384">			stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L385">			stat.setString(index++, content.getId());</span>
<span class="fc" id="L386">			stat.executeUpdate();</span>
<span class="nc" id="L387">		} catch (Throwable t) {</span>
<span class="nc" id="L388">			_logger.error(&quot;Error updating for insert onLine content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L389">			throw new RuntimeException(&quot;Error updating for insert onLine content &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L391">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L393">	}</span>

	/**
	 * Updates the references of a published content
	 * 
	 * @param content
	 * the published content
	 */
	@Override
	public void reloadPublicContentReferences(Content content) {
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">		if (content.isOnLine()) {</span>
<span class="fc" id="L404">			Connection conn = null;</span>
			try {
<span class="fc" id="L406">				conn = this.getConnection();</span>
<span class="fc" id="L407">				conn.setAutoCommit(false);</span>
<span class="fc" id="L408">				this.executeReloadPublicContentReferences(content, conn);</span>
<span class="fc" id="L409">				conn.commit();</span>
<span class="nc" id="L410">			} catch (Throwable t) {</span>
<span class="nc" id="L411">				this.executeRollback(conn);</span>
<span class="nc" id="L412">				_logger.error(&quot;Error reloading references - Content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L413">				throw new RuntimeException(&quot;Error reloading references - Content &quot; + content.getId(), t);</span>
			} finally {
<span class="fc" id="L415">				this.closeConnection(conn);</span>
			}
		}
<span class="fc" id="L418">	}</span>

	protected void executeReloadPublicContentReferences(Content content, Connection conn) throws Throwable {
<span class="fc" id="L421">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L422">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L423">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L424">		this.addPublicContentSearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L425">		this.addContentRelationsRecord(content, conn);</span>
<span class="fc" id="L426">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L427">	}</span>

	/**
	 * Updates the references of a content
	 * 
	 * @param content
	 * the content
	 */
	@Override
	public void reloadWorkContentReferences(Content content) {
<span class="fc" id="L437">		Connection conn = null;</span>
		try {
<span class="fc" id="L439">			conn = this.getConnection();</span>
<span class="fc" id="L440">			conn.setAutoCommit(false);</span>
<span class="fc" id="L441">			this.executeReloadWorkContentReferences(content, conn);</span>
<span class="fc" id="L442">			conn.commit();</span>
<span class="nc" id="L443">		} catch (Throwable t) {</span>
<span class="nc" id="L444">			this.executeRollback(conn);</span>
<span class="nc" id="L445">			_logger.error(&quot;Errore in reloading references - Work Content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L446">			throw new RuntimeException(&quot;Errore in reloading references - Work Content &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L448">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L450">	}</span>

	protected void executeReloadWorkContentReferences(Content content, Connection conn) throws Throwable {
<span class="fc" id="L453">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L454">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L455">		super.deleteEntitySearchRecord(content.getId(), conn);</span>
<span class="fc" id="L456">		super.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L457">		this.addWorkContentRelationsRecord(content, conn);</span>
<span class="fc" id="L458">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L459">	}</span>

	/**
	 * Unpublish a content, preventing it from being displayed in the portal.
	 * Obviously the content itslef is not deleted.
	 * 
	 * @param content
	 * the content to unpublish.
	 */
	@Override
	public void removeOnLineContent(Content content) {
<span class="fc" id="L470">		Connection conn = null;</span>
		try {
<span class="fc" id="L472">			conn = this.getConnection();</span>
<span class="fc" id="L473">			conn.setAutoCommit(false);</span>
<span class="fc" id="L474">			this.executeRemoveOnLineContent(content, conn);</span>
<span class="fc" id="L475">			conn.commit();</span>
<span class="nc" id="L476">		} catch (Throwable t) {</span>
<span class="nc" id="L477">			this.executeRollback(conn);</span>
<span class="nc" id="L478">			_logger.error(&quot;Error removing online content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L479">			throw new RuntimeException(&quot;Error removing online content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L481">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L483">	}</span>

	protected void executeRemoveOnLineContent(Content content, Connection conn) {
<span class="fc" id="L486">		this.executeRemoveOnLineContent(content, true, conn);</span>
<span class="fc" id="L487">	}</span>

	/**
	 * Unpublish a content, preventing it from being displayed in the portal.
	 * Obviously the content itslef is not deleted.
	 * 
	 * @param content
	 * the content to unpublish.
	 * @param updateDate
	 * @param conn
	 * the connection to the DB.
	 */
	protected void executeRemoveOnLineContent(Content content, boolean updateDate, Connection conn) {
<span class="fc" id="L500">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L501">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L502">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L503">		PreparedStatement stat = null;</span>
		try {
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L506">				stat = conn.prepareStatement(REMOVE_ONLINE_CONTENT);</span>
			} else {
<span class="nc" id="L508">				stat = conn.prepareStatement(REMOVE_ONLINE_CONTENT_WITHOUT_DATE);</span>
			}
<span class="fc" id="L510">			int index = 1;</span>
<span class="fc" id="L511">			stat.setString(index++, null);</span>
<span class="fc" id="L512">			stat.setString(index++, null);</span>
<span class="fc" id="L513">			stat.setInt(index++, 0);</span>
<span class="fc" id="L514">			stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L515">			stat.setString(index++, content.getXML());</span>
<span class="fc" id="L516">            String cuttentDateString = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L518">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L520">			stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L521">			stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L522">			stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L523">			stat.setString(index++, content.getId());</span>
<span class="fc" id="L524">			stat.executeUpdate();</span>
<span class="nc" id="L525">		} catch (Throwable t) {</span>
<span class="nc" id="L526">			_logger.error(&quot;Error removing online content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L527">			throw new RuntimeException(&quot;Error removing online content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L529">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L531">	}</span>

	@Override
	protected String getDeleteEntityRecordQuery() {
<span class="fc" id="L535">		return DELETE_CONTENT;</span>
	}

	@Override
	protected void executeDeleteEntity(String entityId, Connection conn) throws Throwable {
<span class="fc" id="L540">		super.deleteRecordsByEntityId(entityId, DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L541">		super.deleteRecordsByEntityId(entityId, DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L542">		super.deleteRecordsByEntityId(entityId, DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L543">		super.deleteRecordsByEntityId(entityId, DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L544">		super.executeDeleteEntity(entityId, conn);</span>
<span class="fc" id="L545">	}</span>

	private void addCategoryRelationsRecord(Content content, boolean isPublicRelations, PreparedStatement stat) throws EntException {
<span class="fc bfc" id="L548" title="All 2 branches covered.">		if (content.getCategories().size() &gt; 0) {</span>
			try {
<span class="fc" id="L550">				Set&lt;String&gt; codes = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L551">				Iterator&lt;Category&gt; categoryIter = content.getCategories().iterator();</span>
<span class="fc bfc" id="L552" title="All 2 branches covered.">				while (categoryIter.hasNext()) {</span>
<span class="fc" id="L553">					Category category = (Category) categoryIter.next();</span>
<span class="fc" id="L554">					this.addCategoryCode(category, codes);</span>
<span class="fc" id="L555">				}</span>
<span class="fc" id="L556">				Iterator&lt;String&gt; codeIter = codes.iterator();</span>
<span class="fc bfc" id="L557" title="All 2 branches covered.">				while (codeIter.hasNext()) {</span>
<span class="fc" id="L558">					String code = codeIter.next();</span>
<span class="fc" id="L559">					int i = 1;</span>
<span class="fc" id="L560">					stat.setString(i++, content.getId());</span>
<span class="fc bfc" id="L561" title="All 2 branches covered.">					if (isPublicRelations) {</span>
<span class="fc" id="L562">						stat.setString(i++, null);</span>
<span class="fc" id="L563">						stat.setString(i++, null);</span>
<span class="fc" id="L564">						stat.setBigDecimal(i++, null);</span>
					}
<span class="fc" id="L566">					stat.setString(i++, code);</span>
<span class="fc bfc" id="L567" title="All 2 branches covered.">					if (isPublicRelations) {</span>
<span class="fc" id="L568">						stat.setString(i++, null);</span>
					}
<span class="fc" id="L570">					stat.addBatch();</span>
<span class="fc" id="L571">					stat.clearParameters();</span>
<span class="fc" id="L572">				}</span>
<span class="nc" id="L573">			} catch (SQLException e) {</span>
<span class="nc" id="L574">				_logger.error(&quot;Error saving content relation record for content {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L575">				throw new RuntimeException(&quot;Error saving content relation record for content &quot; + content.getId(), e.getNextException());</span>
<span class="fc" id="L576">			}</span>
		}
<span class="fc" id="L578">	}</span>
    
    private void addCategoryCode(Category category, Set&lt;String&gt; codes) {
<span class="fc" id="L581">        codes.add(category.getCode());</span>
<span class="fc" id="L582">        Category parentCategory = this.getCategoryManager().getCategory(category.getParentCode());</span>
<span class="pc bpc" id="L583" title="1 of 4 branches missed.">        if (null != parentCategory &amp;&amp; !parentCategory.getCode().equals(parentCategory.getParentCode())) {</span>
<span class="fc" id="L584">            this.addCategoryCode(parentCategory, codes);</span>
        }
<span class="fc" id="L586">    }</span>

	private void addGroupRelationsRecord(Content content, PreparedStatement stat) throws EntException {
		try {
<span class="fc" id="L590">			content.addGroup(content.getMainGroup());</span>
<span class="fc" id="L591">			Iterator&lt;String&gt; groupIter = content.getGroups().iterator();</span>
<span class="fc bfc" id="L592" title="All 2 branches covered.">			while (groupIter.hasNext()) {</span>
<span class="fc" id="L593">				String groupName = groupIter.next();</span>
<span class="fc" id="L594">				stat.setString(1, content.getId());</span>
<span class="fc" id="L595">				stat.setString(2, null);</span>
<span class="fc" id="L596">				stat.setString(3, null);</span>
<span class="fc" id="L597">				stat.setBigDecimal(4, null);</span>
<span class="fc" id="L598">				stat.setString(5, null);</span>
<span class="fc" id="L599">				stat.setString(6, groupName);</span>
<span class="fc" id="L600">				stat.addBatch();</span>
<span class="fc" id="L601">				stat.clearParameters();</span>
<span class="fc" id="L602">			}</span>
<span class="nc" id="L603">		} catch (Throwable t) {</span>
<span class="nc" id="L604">			_logger.error(&quot;Error saving group relation record for content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L605">			throw new RuntimeException(&quot;Error saving group relation record for content &quot; + content.getId(), t);</span>
<span class="fc" id="L606">		}</span>
<span class="fc" id="L607">	}</span>

	/**
	 * Add a record in the table 'contentrelations' for every resource, page,
	 * other content, role and category associated to the given content).
	 * 
	 * @param content
	 * The current content.
	 * @param conn
	 * The connection to the database.
	 * @throws EntException
	 * when connection error are detected.
	 */
	protected void addContentRelationsRecord(Content content, Connection conn) throws EntException {
<span class="fc" id="L621">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L623">			stat = conn.prepareStatement(ADD_CONTENT_REL_RECORD);</span>
<span class="fc" id="L624">			this.addCategoryRelationsRecord(content, true, stat);</span>
<span class="fc" id="L625">			this.addGroupRelationsRecord(content, stat);</span>
<span class="fc" id="L626">			EntityAttributeIterator attributeIter = new EntityAttributeIterator(content);</span>
<span class="fc bfc" id="L627" title="All 2 branches covered.">			while (attributeIter.hasNext()) {</span>
<span class="fc" id="L628">				AttributeInterface currAttribute = (AttributeInterface) attributeIter.next();</span>
<span class="fc bfc" id="L629" title="All 2 branches covered.">				if (currAttribute instanceof IReferenceableAttribute) {</span>
<span class="fc" id="L630">					IReferenceableAttribute cmsAttribute = (IReferenceableAttribute) currAttribute;</span>
<span class="fc" id="L631">					List&lt;CmsAttributeReference&gt; refs = cmsAttribute.getReferences(this.getLangManager().getLangs());</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">					for (int i = 0; i &lt; refs.size(); i++) {</span>
<span class="fc" id="L633">						CmsAttributeReference ref = refs.get(i);</span>
<span class="fc" id="L634">						stat.setString(1, content.getId());</span>
<span class="fc" id="L635">						stat.setString(2, ref.getRefPage());</span>
<span class="fc" id="L636">						stat.setString(3, ref.getRefContent());</span>
<span class="fc" id="L637">						stat.setString(4, ref.getRefResource());</span>
<span class="fc" id="L638">						stat.setString(5, null);</span>
<span class="fc" id="L639">						stat.setString(6, null);</span>
<span class="fc" id="L640">						stat.addBatch();</span>
<span class="fc" id="L641">						stat.clearParameters();</span>
					}
				}
<span class="fc" id="L644">			}</span>
<span class="fc" id="L645">			stat.executeBatch();</span>
<span class="nc" id="L646">		} catch (BatchUpdateException e) {</span>
<span class="nc" id="L647">			_logger.error(&quot;Error saving record into contentrelations {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L648">			throw new RuntimeException(&quot;Error saving record into contentrelations &quot; + content.getId(), e.getNextException());</span>
<span class="nc" id="L649">		} catch (Throwable t) {</span>
<span class="nc" id="L650">			_logger.error(&quot;Error saving record into contentrelations {}&quot;, content.getId(), t);</span>
<span class="nc" id="L651">			throw new RuntimeException(&quot;Error saving record into contentrelations &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L653">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L655">	}</span>

	protected void addWorkContentRelationsRecord(Content content, Connection conn) throws EntException {
<span class="fc" id="L658">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L660">			stat = conn.prepareStatement(ADD_WORK_CONTENT_REL_RECORD);</span>
<span class="fc" id="L661">			this.addCategoryRelationsRecord(content, false, stat);</span>
<span class="fc" id="L662">			stat.executeBatch();</span>
<span class="nc" id="L663">		} catch (BatchUpdateException e) {</span>
<span class="nc" id="L664">			_logger.error(&quot;Error saving record into workcontentrelations {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L665">			throw new RuntimeException(&quot;Error saving record into workcontentrelations &quot; + content.getId(), e);</span>
<span class="nc" id="L666">		} catch (Throwable t) {</span>
<span class="nc" id="L667">			_logger.error(&quot;Error saving record into workcontentrelations {}&quot;, content.getId(), t);</span>
<span class="nc" id="L668">			throw new RuntimeException(&quot;Error saving record into workcontentrelations &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L670">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L672">	}</span>

	protected void addContentAttributeRoleRecord(String id, IApsEntity entity, String query, Connection conn) throws EntException {
<span class="fc" id="L675">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L677">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L678">			super.addEntityAttributeRoleRecord(id, entity, stat);</span>
<span class="nc" id="L679">		} catch (Throwable t) {</span>
<span class="nc" id="L680">			_logger.error(&quot;Error on adding content attribute role records&quot;, t);</span>
<span class="nc" id="L681">			throw new RuntimeException(&quot;Error on adding content attribute role records&quot;, t);</span>
		} finally {
<span class="fc" id="L683">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L685">	}</span>

	@Override
	public List&lt;String&gt; getContentUtilizers(String contentId) {
<span class="fc" id="L689">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L691">			contentIds = this.getUtilizers(contentId, LOAD_REFERENCED_CONTENTS_FOR_CONTENT);</span>
<span class="nc" id="L692">		} catch (Throwable t) {</span>
<span class="nc" id="L693">			_logger.error(&quot;Error loading referenced contents for content {}&quot;, contentId, t);</span>
<span class="nc" id="L694">			throw new RuntimeException(&quot;Error loading referenced contents for content&quot; + contentId, t);</span>
<span class="fc" id="L695">		}</span>
<span class="fc" id="L696">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getPageUtilizers(String pageCode) {
<span class="fc" id="L701">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L703">			contentIds = this.getUtilizers(pageCode, LOAD_REFERENCED_CONTENTS_FOR_PAGE);</span>
<span class="nc" id="L704">		} catch (Throwable t) {</span>
<span class="nc" id="L705">			_logger.error(&quot;Error loading referenced contents for page {}&quot;, pageCode, t);</span>
<span class="nc" id="L706">			throw new RuntimeException(&quot;Error loading referenced contents for page&quot; + pageCode, t);</span>
<span class="fc" id="L707">		}</span>
<span class="fc" id="L708">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getGroupUtilizers(String groupName) {
<span class="fc" id="L713">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L715">			contentIds = this.getUtilizers(groupName, LOAD_REFERENCED_CONTENTS_FOR_GROUP);</span>
<span class="nc" id="L716">		} catch (Throwable t) {</span>
<span class="nc" id="L717">			_logger.error(&quot;Error loading referenced contents for group {}&quot;, groupName, t);</span>
<span class="nc" id="L718">			throw new RuntimeException(&quot;Error loading referenced contents for group &quot; + groupName, t);</span>
<span class="fc" id="L719">		}</span>
<span class="fc" id="L720">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getResourceUtilizers(String resourceId) {
<span class="fc" id="L725">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L727">			contentIds = this.getUtilizers(resourceId, LOAD_REFERENCED_CONTENTS_FOR_RESOURCE);</span>
<span class="nc" id="L728">		} catch (Throwable t) {</span>
<span class="nc" id="L729">			_logger.error(&quot;Error loading referenced contents for resource {}&quot;, resourceId, t);</span>
<span class="nc" id="L730">			throw new RuntimeException(&quot;Error loading referenced contents for resource &quot; + resourceId, t);</span>
<span class="fc" id="L731">		}</span>
<span class="fc" id="L732">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getCategoryUtilizers(String categoryCode) {
<span class="fc" id="L737">		Set&lt;String&gt; result = new HashSet&lt;&gt;();</span>
		try {
<span class="fc" id="L739">			result.addAll(this.getUtilizers(categoryCode, LOAD_REFERENCED_CONTENTS_FOR_CATEGORY));</span>
<span class="fc" id="L740">			result.addAll(this.getUtilizers(categoryCode, LOAD_REFERENCED_WORK_CONTENTS_FOR_CATEGORY));</span>
<span class="nc" id="L741">		} catch (Throwable t) {</span>
<span class="nc" id="L742">			_logger.error(&quot;Error loading referenced contents for category {}&quot;, categoryCode, t);</span>
<span class="nc" id="L743">			throw new RuntimeException(&quot;Error loading referenced contents for category &quot; + categoryCode, t);</span>
<span class="fc" id="L744">		}</span>
<span class="fc" id="L745">		return new ArrayList&lt;&gt;(result);</span>
	}

	protected List&lt;String&gt; getUtilizers(String referencedObjectCode, String query) throws Throwable {
<span class="fc" id="L749">		Connection conn = null;</span>
<span class="fc" id="L750">		List&lt;String&gt; contentIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L751">		PreparedStatement stat = null;</span>
<span class="fc" id="L752">		ResultSet res = null;</span>
		try {
<span class="fc" id="L754">			conn = this.getConnection();</span>
<span class="fc" id="L755">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L756">			stat.setString(1, referencedObjectCode);</span>
<span class="fc" id="L757">			res = stat.executeQuery();</span>
<span class="fc bfc" id="L758" title="All 2 branches covered.">			while (res.next()) {</span>
<span class="fc" id="L759">				String id = res.getString(1);</span>
<span class="fc" id="L760">				contentIds.add(id);</span>
<span class="fc" id="L761">			}</span>
<span class="nc" id="L762">		} catch (Throwable t) {</span>
<span class="nc" id="L763">			throw t;</span>
		} finally {
<span class="fc" id="L765">			closeDaoResources(res, stat, conn);</span>
		}
<span class="fc" id="L767">		return contentIds;</span>
	}

	@Override
	public ContentsStatus loadContentStatus() {
<span class="fc" id="L772">		Connection conn = null;</span>
<span class="fc" id="L773">		PreparedStatement stat = null;</span>
<span class="fc" id="L774">		ResultSet res = null;</span>
<span class="fc" id="L775">		ContentsStatus status = null;</span>
		try {
<span class="fc" id="L777">			conn = this.getConnection();</span>
<span class="fc" id="L778">			int online = this.loadContentStatus(conn, COUNT_ONLINE_CONTENTS);</span>
<span class="fc" id="L779">			int offline = this.loadContentStatus(conn, COUNT_OFFLINE_CONTENTS);</span>
<span class="fc" id="L780">			int withDiffs = this.loadContentStatus(conn, COUNT_ONLINE_CONTENTS_WITH_DIFFS);</span>
<span class="fc" id="L781">			Date lastModified = this.loadContentStatusLastModified(conn, LOAD_LAST_MODIFIED_DATE);</span>
<span class="fc" id="L782">			status = new ContentsStatus();</span>
<span class="fc" id="L783">			status.setDraft(offline);</span>
<span class="fc" id="L784">			status.setOnline(online);</span>
<span class="fc" id="L785">			status.setOnlineWithChanges(withDiffs);</span>
<span class="fc" id="L786">			status.setLastUpdate(lastModified);</span>
<span class="nc" id="L787">		} catch (Throwable t) {</span>
<span class="nc" id="L788">			_logger.error(&quot;Error loading contents status&quot;, t);</span>
<span class="nc" id="L789">			throw new RuntimeException(&quot;Error loading contents status&quot;, t);</span>
		} finally {
<span class="fc" id="L791">			closeDaoResources(res, stat, conn);</span>
		}
<span class="fc" id="L793">		return status;</span>
	}

	private int loadContentStatus(Connection conn, String query) {
<span class="fc" id="L797">		PreparedStatement stat = null;</span>
<span class="fc" id="L798">		ResultSet res = null;</span>
<span class="fc" id="L799">		int count = 0;</span>
		try {
<span class="fc" id="L801">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L802">			res = stat.executeQuery();</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">			if (res.next()) {</span>
<span class="fc" id="L804">				count = res.getInt(1);</span>
			}
<span class="nc" id="L806">		} catch (Throwable t) {</span>
<span class="nc" id="L807">            _logger.error(&quot;Error loading contents status &quot;, t);</span>
<span class="nc" id="L808">			throw new RuntimeException(&quot;Error loading contents status&quot;, t);</span>
		} finally {
<span class="fc" id="L810">			closeDaoResources(res, stat);</span>
		}
<span class="fc" id="L812">		return count;</span>
	}

	private Date loadContentStatusLastModified(Connection conn, String query) {
<span class="fc" id="L816">		PreparedStatement stat = null;</span>
<span class="fc" id="L817">		ResultSet res = null;</span>
<span class="fc" id="L818">		Date lastModified = null;</span>
		try {
<span class="fc" id="L820">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L821">			res = stat.executeQuery();</span>
<span class="pc bpc" id="L822" title="1 of 2 branches missed.">			if (res.next()) {</span>
<span class="fc" id="L823">				String lastMod = res.getString(1);</span>
<span class="fc" id="L824">				lastModified = DateConverter.parseDate(lastMod, SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
			}
<span class="nc" id="L826">		} catch (Throwable t) {</span>
<span class="nc" id="L827">			_logger.error(&quot;Error loading contents status last modified date&quot;, t);</span>
<span class="nc" id="L828">			throw new RuntimeException(&quot;Error loading contents status last modified date&quot;, t);</span>
		} finally {
<span class="fc" id="L830">			closeDaoResources(res, stat);</span>
		}
<span class="fc" id="L832">		return lastModified;</span>
	}

	@Override
	protected String getAddingSearchRecordQuery() {
<span class="fc" id="L837">		return ADD_WORK_CONTENT_SEARCH_RECORD;</span>
	}

	@Override
	protected String getRemovingSearchRecordQuery() {
<span class="fc" id="L842">		return DELETE_WORK_CONTENT_SEARCH_RECORD;</span>
	}

	@Override
	protected String getAddingAttributeRoleRecordQuery() {
<span class="fc" id="L847">		return ADD_WORK_ATTRIBUTE_ROLE_RECORD;</span>
	}

	@Override
	protected String getRemovingAttributeRoleRecordQuery() {
<span class="fc" id="L852">		return DELETE_WORK_ATTRIBUTE_ROLE_RECORD;</span>
	}

	@Override
	protected String getExtractingAllEntityIdQuery() {
<span class="fc" id="L857">		return LOAD_ALL_CONTENTS_ID;</span>
	}

    protected ICategoryManager getCategoryManager() {
<span class="fc" id="L861">        return categoryManager;</span>
    }

    public void setCategoryManager(ICategoryManager categoryManager) {
<span class="fc" id="L865">        this.categoryManager = categoryManager;</span>
<span class="fc" id="L866">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>