<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContentDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Plugin: CMS</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.plugins.jacms.aps.system.services.content</a> &gt; <span class="el_source">ContentDAO.java</span></div><h1>ContentDAO.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package com.agiletec.plugins.jacms.aps.system.services.content;

import com.agiletec.aps.system.SystemConstants;
import java.sql.BatchUpdateException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;

import com.agiletec.aps.system.common.entity.AbstractEntityDAO;
import com.agiletec.aps.system.common.entity.model.ApsEntityRecord;
import com.agiletec.aps.system.common.entity.model.IApsEntity;
import com.agiletec.aps.system.common.entity.model.attribute.AttributeInterface;
import com.agiletec.aps.system.common.util.EntityAttributeIterator;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.category.Category;
import com.agiletec.aps.system.services.category.ICategoryManager;
import com.agiletec.aps.util.DateConverter;
import com.agiletec.plugins.jacms.aps.system.services.content.model.CmsAttributeReference;
import com.agiletec.plugins.jacms.aps.system.services.content.model.Content;
import com.agiletec.plugins.jacms.aps.system.services.content.model.ContentRecordVO;
import com.agiletec.plugins.jacms.aps.system.services.content.model.attribute.IReferenceableAttribute;
import org.apache.commons.lang3.StringUtils;

/**
 * DAO class for objects of type content.
 * 
 * @author M.Diana - E.Santoboni - S.Didaci
 */
<span class="fc" id="L52">public class ContentDAO extends AbstractEntityDAO implements IContentDAO {</span>

<span class="fc" id="L54">	private static final EntLogger _logger = EntLogFactory.getSanitizedLogger(ContentDAO.class);</span>

	private static final String DELETE_CONTENT = &quot;DELETE FROM contents WHERE contentid = ? &quot;;

	private static final String DELETE_CONTENT_REL_RECORD = &quot;DELETE FROM contentrelations WHERE contentid = ? &quot;;

	private static final String DELETE_WORK_CONTENT_REL_RECORD = &quot;DELETE FROM workcontentrelations WHERE contentid = ? &quot;;

	private static final String ADD_CONTENT_SEARCH_RECORD = &quot;INSERT INTO contentsearch (contentid, attrname, textvalue, datevalue, numvalue, langcode) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String DELETE_CONTENT_SEARCH_RECORD = &quot;DELETE FROM contentsearch WHERE contentid = ? &quot;;

	private static final String ADD_WORK_CONTENT_SEARCH_RECORD = &quot;INSERT INTO workcontentsearch (contentid, attrname, textvalue, datevalue, numvalue, langcode) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String DELETE_WORK_CONTENT_SEARCH_RECORD = &quot;DELETE FROM workcontentsearch WHERE contentid = ? &quot;;

	private static final String ADD_CONTENT_REL_RECORD = &quot;INSERT INTO contentrelations &quot;
			+ &quot;(contentid, refpage, refcontent, refresource, refcategory, refgroup) VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

	private static final String ADD_WORK_CONTENT_REL_RECORD = &quot;INSERT INTO workcontentrelations (contentid, refcategory) VALUES ( ? , ? )&quot;;

	private static final String LOAD_CONTENTS_ID_MAIN_BLOCK = &quot;SELECT DISTINCT contents.contentid FROM contents &quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_PAGE = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refpage = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_CONTENT = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refcontent = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_GROUP = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refgroup = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_RESOURCE = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refresource = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_REFERENCED_CONTENTS_FOR_CATEGORY = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN contentrelations ON contents.contentid = contentrelations.contentid WHERE refcategory = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String LOAD_CONTENTS_VO_MAIN_BLOCK = &quot;SELECT contents.contentid, contents.contenttype, contents.descr, &quot;
            + &quot;contents.status, contents.workxml, contents.created, contents.lastmodified, contents.onlinexml, contents.published, &quot;
            + &quot;contents.sync, contents.maingroup, contents.currentversion, contents.firsteditor, contents.lasteditor, contents.restriction FROM contents &quot;;

	private static final String LOAD_CONTENT_VO = LOAD_CONTENTS_VO_MAIN_BLOCK + &quot; WHERE contents.contentid = ? &quot;;

	private static final String LOAD_REFERENCED_WORK_CONTENTS_FOR_CATEGORY = LOAD_CONTENTS_ID_MAIN_BLOCK
			+ &quot; RIGHT JOIN workcontentrelations ON contents.contentid = workcontentrelations.contentid WHERE refcategory = ? &quot;
			+ &quot;ORDER BY contents.contentid&quot;;

	private static final String ADD_CONTENT = &quot;INSERT INTO contents (contentid, contenttype, descr, status, workxml, &quot;
			+ &quot;created, lastmodified, sync, maingroup, currentversion, firsteditor, lasteditor, restriction) &quot;
			+ &quot;VALUES ( ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ?)&quot;;

	private static final String UPDATE_CONTENTS = &quot;UPDATE contents SET contenttype = ? , descr = ? , status = ? , &quot;;

	private static final String INSERT_ONLINE_CONTENT = UPDATE_CONTENTS
			+ &quot;workxml = ? , lastmodified = ? , onlinexml = ? , published = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , &quot;
			+ &quot;restriction = ? WHERE contentid = ? &quot;;

	private static final String INSERT_ONLINE_CONTENT_WITHOUT_DATE = UPDATE_CONTENTS
			+ &quot;workxml = ? , onlinexml = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String REMOVE_ONLINE_CONTENT = &quot;UPDATE contents SET onlinexml = ? , published = ? , sync = ? , &quot;
            + &quot;status = ? , workxml = ? , lastmodified = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String REMOVE_ONLINE_CONTENT_WITHOUT_DATE = &quot;UPDATE contents SET onlinexml = ? , published = ? , sync = ? , &quot;
            + &quot;status = ? , workxml = ? , currentversion = ? , lasteditor = ? , restriction = ? WHERE contentid = ? &quot;;

	private static final String UPDATE_CONTENT = UPDATE_CONTENTS
			+ &quot;workxml = ? , sync = ? , lastmodified = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? &quot; + &quot;WHERE contentid = ? &quot;;

	private static final String UPDATE_CONTENT_WITHOUT_DATE = UPDATE_CONTENTS
			+ &quot;workxml = ? , sync = ? , maingroup = ? , currentversion = ? , lasteditor = ? , restriction = ? &quot; + &quot;WHERE contentid = ? &quot;;

	private static final String LOAD_ALL_CONTENTS_ID = &quot;SELECT contentid FROM contents&quot;;

	private static final String ADD_ATTRIBUTE_ROLE_RECORD = &quot;INSERT INTO contentattributeroles (contentid, attrname, rolename) VALUES ( ? , ? , ? )&quot;;

	private static final String DELETE_ATTRIBUTE_ROLE_RECORD = &quot;DELETE FROM contentattributeroles WHERE contentid = ? &quot;;

	private static final String ADD_WORK_ATTRIBUTE_ROLE_RECORD = &quot;INSERT INTO workcontentattributeroles (contentid, attrname, rolename) VALUES ( ? , ? , ? )&quot;;

	private static final String DELETE_WORK_ATTRIBUTE_ROLE_RECORD = &quot;DELETE FROM workcontentattributeroles WHERE contentid = ? &quot;;
    
	private static final String COUNT_OFFLINE_CONTENTS = 
            &quot;SELECT count(contents.contentid) from contents WHERE contents.sync = 0 and onlinexml is null&quot;;

	private static final String COUNT_ONLINE_CONTENTS = 
            &quot;SELECT count(contentid) from contents WHERE contents.sync = 1&quot;;

	private static final String COUNT_ONLINE_CONTENTS_WITH_DIFFS = 
            &quot;SELECT count(contents.contentid) from contents WHERE contents.sync = 0 and onlinexml is not null&quot;;
    
    private static final String LOAD_LAST_MODIFIED_DATE  = &quot;SELECT MAX(lastmodified) FROM contents&quot;;
    
    private ICategoryManager categoryManager;

	@Override
	protected String getLoadEntityRecordQuery() {
<span class="fc" id="L159">		return LOAD_CONTENT_VO;</span>
	}

	@Override
	protected ApsEntityRecord createEntityRecord(ResultSet res) throws Throwable {
<span class="fc" id="L164">        ContentRecordVO contentVo = new ContentRecordVO();</span>
<span class="fc" id="L165">		contentVo.setId(res.getString(&quot;contentid&quot;));</span>
<span class="fc" id="L166">		contentVo.setTypeCode(res.getString(&quot;contenttype&quot;));</span>
<span class="fc" id="L167">		contentVo.setDescription(res.getString(&quot;descr&quot;));</span>
<span class="fc" id="L168">		contentVo.setStatus(res.getString(&quot;status&quot;));</span>
<span class="fc" id="L169">		String xmlWork = res.getString(&quot;workxml&quot;);</span>
<span class="fc" id="L170">		contentVo.setCreate(DateConverter.parseDate(res.getString(&quot;created&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L171">		contentVo.setModify(DateConverter.parseDate(res.getString(&quot;lastmodified&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L172">		contentVo.setPublish(DateConverter.parseDate(res.getString(&quot;published&quot;), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L173">		String xmlOnLine = res.getString(&quot;onlinexml&quot;);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		contentVo.setOnLine(!StringUtils.isBlank(xmlOnLine));</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">		contentVo.setSync(res.getInt(&quot;sync&quot;) == 1);</span>
<span class="fc" id="L176">		contentVo.setMainGroupCode(res.getString(&quot;maingroup&quot;));</span>
<span class="fc" id="L177">		contentVo.setXmlWork(xmlWork);</span>
<span class="fc" id="L178">		contentVo.setXmlOnLine(xmlOnLine);</span>
<span class="fc" id="L179">		contentVo.setVersion(res.getString(&quot;currentversion&quot;));</span>
<span class="fc" id="L180">		contentVo.setFirstEditor(res.getString(&quot;firsteditor&quot;));</span>
<span class="fc" id="L181">		contentVo.setLastEditor(res.getString(&quot;lasteditor&quot;));</span>
<span class="fc" id="L182">		contentVo.setRestriction(res.getString(&quot;restriction&quot;));</span>
<span class="fc" id="L183">		return contentVo;</span>
	}

	@Override
	protected void executeAddEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L188">		super.executeAddEntity(entity, conn);</span>
<span class="fc" id="L189">		this.addWorkContentRelationsRecord((Content) entity, conn);</span>
<span class="fc" id="L190">	}</span>

	@Override
	protected String getAddEntityRecordQuery() {
<span class="fc" id="L194">		return ADD_CONTENT;</span>
	}
    
	@Override
	protected void buildAddEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L199">		Content content = (Content) entity;</span>
<span class="fc" id="L200">		stat.setString(1, content.getId());</span>
<span class="fc" id="L201">		stat.setString(2, content.getTypeCode());</span>
<span class="fc" id="L202">		stat.setString(3, content.getDescription());</span>
<span class="fc" id="L203">		stat.setString(4, content.getStatus());</span>
<span class="fc" id="L204">		stat.setString(5, content.getXML());</span>
<span class="fc" id="L205">		String currentDate = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="fc" id="L206">		stat.setString(6, currentDate);</span>
<span class="fc" id="L207">		stat.setString(7, currentDate);</span>
<span class="fc" id="L208">		stat.setInt(8, 0);</span>
<span class="fc" id="L209">		stat.setString(9, content.getMainGroup());</span>
<span class="fc" id="L210">		stat.setString(10, content.getVersion());</span>
<span class="fc" id="L211">		stat.setString(11, content.getFirstEditor());</span>
<span class="fc" id="L212">		stat.setString(12, content.getLastEditor());</span>
<span class="fc" id="L213">		stat.setString(13, content.getRestriction());</span>
<span class="fc" id="L214">	}</span>

	@Override
	public void updateContent(Content content, boolean updateDate) {
<span class="fc" id="L218">		Connection conn = null;</span>
		try {
<span class="fc" id="L220">			conn = this.getConnection();</span>
<span class="fc" id="L221">			conn.setAutoCommit(false);</span>
<span class="fc" id="L222">			this.executeUpdateContent(content, updateDate, conn);</span>
<span class="fc" id="L223">			conn.commit();</span>
<span class="nc" id="L224">		} catch (Throwable t) {</span>
<span class="nc" id="L225">			this.executeRollback(conn);</span>
<span class="nc" id="L226">			_logger.error(&quot;Error updating content&quot;, t);</span>
<span class="nc" id="L227">			throw new RuntimeException(&quot;Error updating content&quot;, t);</span>
		} finally {
<span class="fc" id="L229">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L231">	}</span>

	protected void executeUpdateContent(Content content, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L234">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L236">			this.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L237">			this.deleteRecordsByEntityId(content.getId(), this.getRemovingSearchRecordQuery(), conn);</span>
<span class="fc" id="L238">			this.deleteRecordsByEntityId(content.getId(), this.getRemovingAttributeRoleRecordQuery(), conn);</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L240">				stat = conn.prepareStatement(this.getUpdateEntityRecordQuery());</span>
			} else {
<span class="nc" id="L242">				stat = conn.prepareStatement(this.getUpdateEntityRecordQueryWithoutDate());</span>
			}
<span class="fc" id="L244">			this.buildUpdateEntityStatement(content, updateDate, stat);</span>
<span class="fc" id="L245">			stat.executeUpdate();</span>
<span class="fc" id="L246">			this.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L247">			this.addEntityAttributeRoleRecord(content.getId(), content, conn);</span>
<span class="fc" id="L248">			this.addWorkContentRelationsRecord(content, conn);</span>
<span class="nc" id="L249">		} catch (Throwable t) {</span>
<span class="nc" id="L250">			throw t;</span>
		} finally {
<span class="fc" id="L252">			this.closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L254">	}</span>

	@Override
	protected void executeUpdateEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L258">		this.deleteRecordsByEntityId(entity.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L259">		super.executeUpdateEntity(entity, conn);</span>
<span class="fc" id="L260">		this.addWorkContentRelationsRecord((Content) entity, conn);</span>
<span class="fc" id="L261">	}</span>

	@Override
	protected String getUpdateEntityRecordQuery() {
<span class="fc" id="L265">		return UPDATE_CONTENT;</span>
	}

	protected String getUpdateEntityRecordQueryWithoutDate() {
<span class="nc" id="L269">		return UPDATE_CONTENT_WITHOUT_DATE;</span>
	}

	@Override
	protected void buildUpdateEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L274">		this.buildUpdateEntityStatement(entity, true, stat);</span>
<span class="fc" id="L275">	}</span>

	protected void buildUpdateEntityStatement(IApsEntity entity, boolean updateDate, PreparedStatement stat) throws Throwable {
<span class="fc" id="L278">		Content content = (Content) entity;</span>
<span class="fc" id="L279">		int index = 1;</span>
<span class="fc" id="L280">		stat.setString(index++, content.getTypeCode());</span>
<span class="fc" id="L281">		stat.setString(index++, content.getDescription());</span>
<span class="fc" id="L282">		stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L283">		stat.setString(index++, content.getXML());</span>
<span class="fc" id="L284">		stat.setInt(index++, 0);</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (updateDate) {</span>
<span class="fc" id="L286">			stat.setString(index++, DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
		}
<span class="fc" id="L288">		stat.setString(index++, content.getMainGroup());</span>
<span class="fc" id="L289">		stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L290">		stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L291">		stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L292">		stat.setString(index++, content.getId());</span>
<span class="fc" id="L293">	}</span>

	/**
	 * This publishes a content.
	 * 
	 * @param content
	 * the content to publish.
	 */
	@Override
	public void insertOnLineContent(Content content) {
<span class="fc" id="L303">		Connection conn = null;</span>
		try {
<span class="fc" id="L305">			conn = this.getConnection();</span>
<span class="fc" id="L306">			conn.setAutoCommit(false);</span>
<span class="fc" id="L307">			this.executeInsertOnLineContent(content, conn);</span>
<span class="fc" id="L308">			conn.commit();</span>
<span class="nc" id="L309">		} catch (Throwable t) {</span>
<span class="nc" id="L310">			this.executeRollback(conn);</span>
<span class="nc" id="L311">			_logger.error(&quot;Error publish content {} &quot;, content.getId(), t);</span>
<span class="nc" id="L312">			throw new RuntimeException(&quot;Error publish content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L314">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L316">	}</span>

	protected void executeInsertOnLineContent(Content content, Connection conn) throws Throwable {
<span class="fc" id="L319">		this.executeInsertOnLineContent(content, true, conn);</span>
<span class="fc" id="L320">	}</span>

	protected void executeInsertOnLineContent(Content content, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L323">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L324">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L325">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L326">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L327">		super.deleteEntitySearchRecord(content.getId(), conn);</span>
<span class="fc" id="L328">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L329">		this.updateContentRecordForInsertOnLine(content, updateDate, conn);</span>
<span class="fc" id="L330">		this.addPublicContentSearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L331">		super.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L332">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L333">		this.addWorkContentRelationsRecord(content, conn);</span>
<span class="fc" id="L334">		this.addContentRelationsRecord(content, conn);</span>
<span class="fc" id="L335">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L336">	}</span>

	@Deprecated
	protected void deletePublicContentSearchRecord(String id, Connection conn) throws EntException {
<span class="nc" id="L340">		super.deleteRecordsByEntityId(id, DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="nc" id="L341">	}</span>

	protected void addPublicContentSearchRecord(String id, IApsEntity entity, Connection conn) throws EntException {
<span class="fc" id="L344">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L346">			stat = conn.prepareStatement(ADD_CONTENT_SEARCH_RECORD);</span>
<span class="fc" id="L347">			this.addEntitySearchRecord(id, entity, stat);</span>
<span class="nc" id="L348">		} catch (Throwable t) {</span>
<span class="nc" id="L349">			_logger.error(&quot;Error on adding public content search records&quot;, t);</span>
<span class="nc" id="L350">			throw new RuntimeException(&quot;Error on adding public content search records&quot;, t);</span>
		} finally {
<span class="fc" id="L352">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L354">	}</span>

	protected void updateContentRecordForInsertOnLine(Content content, Connection conn) throws EntException {
<span class="nc" id="L357">		this.updateContentRecordForInsertOnLine(content, true, conn);</span>
<span class="nc" id="L358">	}</span>

	protected void updateContentRecordForInsertOnLine(Content content, boolean updateDate, Connection conn) throws EntException {
<span class="fc" id="L361">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L363">			int index = 1;</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L365">				stat = conn.prepareStatement(INSERT_ONLINE_CONTENT);</span>
			} else {
<span class="nc" id="L367">				stat = conn.prepareStatement(INSERT_ONLINE_CONTENT_WITHOUT_DATE);</span>
			}
<span class="fc" id="L369">			stat.setString(index++, content.getTypeCode());</span>
<span class="fc" id="L370">			stat.setString(index++, content.getDescription());</span>
<span class="fc" id="L371">			stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L372">			String xml = content.getXML();</span>
<span class="fc" id="L373">			stat.setString(index++, xml);</span>
<span class="fc" id="L374">            String cuttentDateString = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L376">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L378">			stat.setString(index++, xml);</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L380">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L382">            stat.setInt(index++, 1);</span>
<span class="fc" id="L383">			stat.setString(index++, content.getMainGroup());</span>
<span class="fc" id="L384">			stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L385">			stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L386">			stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L387">			stat.setString(index++, content.getId());</span>
<span class="fc" id="L388">			stat.executeUpdate();</span>
<span class="nc" id="L389">		} catch (Throwable t) {</span>
<span class="nc" id="L390">			_logger.error(&quot;Error updating for insert onLine content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L391">			throw new RuntimeException(&quot;Error updating for insert onLine content &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L393">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L395">	}</span>

	/**
	 * Updates the references of a published content
	 * 
	 * @param content
	 * the published content
	 */
	@Override
	public void reloadPublicContentReferences(Content content) {
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">		if (content.isOnLine()) {</span>
<span class="fc" id="L406">			Connection conn = null;</span>
			try {
<span class="fc" id="L408">				conn = this.getConnection();</span>
<span class="fc" id="L409">				conn.setAutoCommit(false);</span>
<span class="fc" id="L410">				this.executeReloadPublicContentReferences(content, conn);</span>
<span class="fc" id="L411">				conn.commit();</span>
<span class="nc" id="L412">			} catch (Throwable t) {</span>
<span class="nc" id="L413">				this.executeRollback(conn);</span>
<span class="nc" id="L414">				_logger.error(&quot;Error reloading references - Content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L415">				throw new RuntimeException(&quot;Error reloading references - Content &quot; + content.getId(), t);</span>
			} finally {
<span class="fc" id="L417">				this.closeConnection(conn);</span>
			}
		}
<span class="fc" id="L420">	}</span>

	protected void executeReloadPublicContentReferences(Content content, Connection conn) throws Throwable {
<span class="fc" id="L423">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L424">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L425">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L426">		this.addPublicContentSearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L427">		this.addContentRelationsRecord(content, conn);</span>
<span class="fc" id="L428">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L429">	}</span>

	/**
	 * Updates the references of a content
	 * 
	 * @param content
	 * the content
	 */
	@Override
	public void reloadWorkContentReferences(Content content) {
<span class="fc" id="L439">		Connection conn = null;</span>
		try {
<span class="fc" id="L441">			conn = this.getConnection();</span>
<span class="fc" id="L442">			conn.setAutoCommit(false);</span>
<span class="fc" id="L443">			this.executeReloadWorkContentReferences(content, conn);</span>
<span class="fc" id="L444">			conn.commit();</span>
<span class="nc" id="L445">		} catch (Throwable t) {</span>
<span class="nc" id="L446">			this.executeRollback(conn);</span>
<span class="nc" id="L447">			_logger.error(&quot;Errore in reloading references - Work Content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L448">			throw new RuntimeException(&quot;Errore in reloading references - Work Content &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L450">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L452">	}</span>

	protected void executeReloadWorkContentReferences(Content content, Connection conn) throws Throwable {
<span class="fc" id="L455">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L456">		super.deleteRecordsByEntityId(content.getId(), DELETE_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L457">		super.deleteEntitySearchRecord(content.getId(), conn);</span>
<span class="fc" id="L458">		super.addEntitySearchRecord(content.getId(), content, conn);</span>
<span class="fc" id="L459">		this.addWorkContentRelationsRecord(content, conn);</span>
<span class="fc" id="L460">		this.addContentAttributeRoleRecord(content.getId(), content, ADD_WORK_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L461">	}</span>

	/**
	 * Unpublish a content, preventing it from being displayed in the portal.
	 * Obviously the content itslef is not deleted.
	 * 
	 * @param content
	 * the content to unpublish.
	 */
	@Override
	public void removeOnLineContent(Content content) {
<span class="fc" id="L472">		Connection conn = null;</span>
		try {
<span class="fc" id="L474">			conn = this.getConnection();</span>
<span class="fc" id="L475">			conn.setAutoCommit(false);</span>
<span class="fc" id="L476">			this.executeRemoveOnLineContent(content, conn);</span>
<span class="fc" id="L477">			conn.commit();</span>
<span class="nc" id="L478">		} catch (Throwable t) {</span>
<span class="nc" id="L479">			this.executeRollback(conn);</span>
<span class="nc" id="L480">			_logger.error(&quot;Error removing online content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L481">			throw new RuntimeException(&quot;Error removing online content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L483">			this.closeConnection(conn);</span>
		}
<span class="fc" id="L485">	}</span>

	protected void executeRemoveOnLineContent(Content content, Connection conn) {
<span class="fc" id="L488">		this.executeRemoveOnLineContent(content, true, conn);</span>
<span class="fc" id="L489">	}</span>

	/**
	 * Unpublish a content, preventing it from being displayed in the portal.
	 * Obviously the content itslef is not deleted.
	 * 
	 * @param content
	 * the content to unpublish.
	 * @param updateDate
	 * @param conn
	 * the connection to the DB.
	 */
	protected void executeRemoveOnLineContent(Content content, boolean updateDate, Connection conn) {
<span class="fc" id="L502">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L503">		super.deleteRecordsByEntityId(content.getId(), DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L504">		super.deleteRecordsByEntityId(content.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L505">		PreparedStatement stat = null;</span>
		try {
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L508">				stat = conn.prepareStatement(REMOVE_ONLINE_CONTENT);</span>
			} else {
<span class="nc" id="L510">				stat = conn.prepareStatement(REMOVE_ONLINE_CONTENT_WITHOUT_DATE);</span>
			}
<span class="fc" id="L512">			int index = 1;</span>
<span class="fc" id="L513">			stat.setString(index++, null);</span>
<span class="fc" id="L514">			stat.setString(index++, null);</span>
<span class="fc" id="L515">			stat.setInt(index++, 0);</span>
<span class="fc" id="L516">			stat.setString(index++, content.getStatus());</span>
<span class="fc" id="L517">			stat.setString(index++, content.getXML());</span>
<span class="fc" id="L518">            String cuttentDateString = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">			if (updateDate) {</span>
<span class="fc" id="L520">				stat.setString(index++, cuttentDateString);</span>
			}
<span class="fc" id="L522">			stat.setString(index++, content.getVersion());</span>
<span class="fc" id="L523">			stat.setString(index++, content.getLastEditor());</span>
<span class="fc" id="L524">			stat.setString(index++, content.getRestriction());</span>
<span class="fc" id="L525">			stat.setString(index++, content.getId());</span>
<span class="fc" id="L526">			stat.executeUpdate();</span>
<span class="nc" id="L527">		} catch (Throwable t) {</span>
<span class="nc" id="L528">			_logger.error(&quot;Error removing online content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L529">			throw new RuntimeException(&quot;Error removing online content - &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L531">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L533">	}</span>

	@Override
	protected String getDeleteEntityRecordQuery() {
<span class="fc" id="L537">		return DELETE_CONTENT;</span>
	}

	@Override
	protected void executeDeleteEntity(String entityId, Connection conn) throws Throwable {
<span class="fc" id="L542">		super.deleteRecordsByEntityId(entityId, DELETE_CONTENT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L543">		super.deleteRecordsByEntityId(entityId, DELETE_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L544">		super.deleteRecordsByEntityId(entityId, DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L545">		super.deleteRecordsByEntityId(entityId, DELETE_WORK_CONTENT_REL_RECORD, conn);</span>
<span class="fc" id="L546">		super.executeDeleteEntity(entityId, conn);</span>
<span class="fc" id="L547">	}</span>

	private void addCategoryRelationsRecord(Content content, boolean isPublicRelations, PreparedStatement stat) throws EntException {
<span class="fc bfc" id="L550" title="All 2 branches covered.">		if (content.getCategories().size() &gt; 0) {</span>
			try {
<span class="fc" id="L552">				Set&lt;String&gt; codes = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L553">				Iterator&lt;Category&gt; categoryIter = content.getCategories().iterator();</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">				while (categoryIter.hasNext()) {</span>
<span class="fc" id="L555">					Category category = (Category) categoryIter.next();</span>
<span class="fc" id="L556">					this.addCategoryCode(category, codes);</span>
<span class="fc" id="L557">				}</span>
<span class="fc" id="L558">				Iterator&lt;String&gt; codeIter = codes.iterator();</span>
<span class="fc bfc" id="L559" title="All 2 branches covered.">				while (codeIter.hasNext()) {</span>
<span class="fc" id="L560">					String code = codeIter.next();</span>
<span class="fc" id="L561">					int i = 1;</span>
<span class="fc" id="L562">					stat.setString(i++, content.getId());</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">					if (isPublicRelations) {</span>
<span class="fc" id="L564">						stat.setString(i++, null);</span>
<span class="fc" id="L565">						stat.setString(i++, null);</span>
<span class="fc" id="L566">						stat.setBigDecimal(i++, null);</span>
					}
<span class="fc" id="L568">					stat.setString(i++, code);</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">					if (isPublicRelations) {</span>
<span class="fc" id="L570">						stat.setString(i++, null);</span>
					}
<span class="fc" id="L572">					stat.addBatch();</span>
<span class="fc" id="L573">					stat.clearParameters();</span>
<span class="fc" id="L574">				}</span>
<span class="nc" id="L575">			} catch (SQLException e) {</span>
<span class="nc" id="L576">				_logger.error(&quot;Error saving content relation record for content {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L577">				throw new RuntimeException(&quot;Error saving content relation record for content &quot; + content.getId(), e.getNextException());</span>
<span class="fc" id="L578">			}</span>
		}
<span class="fc" id="L580">	}</span>
    
    private void addCategoryCode(Category category, Set&lt;String&gt; codes) {
<span class="fc" id="L583">        codes.add(category.getCode());</span>
<span class="fc" id="L584">        Category parentCategory = this.getCategoryManager().getCategory(category.getParentCode());</span>
<span class="pc bpc" id="L585" title="1 of 4 branches missed.">        if (null != parentCategory &amp;&amp; !parentCategory.getCode().equals(parentCategory.getParentCode())) {</span>
<span class="fc" id="L586">            this.addCategoryCode(parentCategory, codes);</span>
        }
<span class="fc" id="L588">    }</span>

	private void addGroupRelationsRecord(Content content, PreparedStatement stat) throws EntException {
		try {
<span class="fc" id="L592">			content.addGroup(content.getMainGroup());</span>
<span class="fc" id="L593">			Iterator&lt;String&gt; groupIter = content.getGroups().iterator();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">			while (groupIter.hasNext()) {</span>
<span class="fc" id="L595">				String groupName = groupIter.next();</span>
<span class="fc" id="L596">				stat.setString(1, content.getId());</span>
<span class="fc" id="L597">				stat.setString(2, null);</span>
<span class="fc" id="L598">				stat.setString(3, null);</span>
<span class="fc" id="L599">				stat.setBigDecimal(4, null);</span>
<span class="fc" id="L600">				stat.setString(5, null);</span>
<span class="fc" id="L601">				stat.setString(6, groupName);</span>
<span class="fc" id="L602">				stat.addBatch();</span>
<span class="fc" id="L603">				stat.clearParameters();</span>
<span class="fc" id="L604">			}</span>
<span class="nc" id="L605">		} catch (Throwable t) {</span>
<span class="nc" id="L606">			_logger.error(&quot;Error saving group relation record for content {}&quot;, content.getId(), t);</span>
<span class="nc" id="L607">			throw new RuntimeException(&quot;Error saving group relation record for content &quot; + content.getId(), t);</span>
<span class="fc" id="L608">		}</span>
<span class="fc" id="L609">	}</span>

	/**
	 * Add a record in the table 'contentrelations' for every resource, page,
	 * other content, role and category associated to the given content).
	 * 
	 * @param content
	 * The current content.
	 * @param conn
	 * The connection to the database.
	 * @throws EntException
	 * when connection error are detected.
	 */
	protected void addContentRelationsRecord(Content content, Connection conn) throws EntException {
<span class="fc" id="L623">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L625">			stat = conn.prepareStatement(ADD_CONTENT_REL_RECORD);</span>
<span class="fc" id="L626">			this.addCategoryRelationsRecord(content, true, stat);</span>
<span class="fc" id="L627">			this.addGroupRelationsRecord(content, stat);</span>
<span class="fc" id="L628">			EntityAttributeIterator attributeIter = new EntityAttributeIterator(content);</span>
<span class="fc bfc" id="L629" title="All 2 branches covered.">			while (attributeIter.hasNext()) {</span>
<span class="fc" id="L630">				AttributeInterface currAttribute = (AttributeInterface) attributeIter.next();</span>
<span class="fc bfc" id="L631" title="All 2 branches covered.">				if (currAttribute instanceof IReferenceableAttribute) {</span>
<span class="fc" id="L632">					IReferenceableAttribute cmsAttribute = (IReferenceableAttribute) currAttribute;</span>
<span class="fc" id="L633">					List&lt;CmsAttributeReference&gt; refs = cmsAttribute.getReferences(this.getLangManager().getLangs());</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">					for (int i = 0; i &lt; refs.size(); i++) {</span>
<span class="fc" id="L635">						CmsAttributeReference ref = refs.get(i);</span>
<span class="fc" id="L636">						stat.setString(1, content.getId());</span>
<span class="fc" id="L637">						stat.setString(2, ref.getRefPage());</span>
<span class="fc" id="L638">						stat.setString(3, ref.getRefContent());</span>
<span class="fc" id="L639">						stat.setString(4, ref.getRefResource());</span>
<span class="fc" id="L640">						stat.setString(5, null);</span>
<span class="fc" id="L641">						stat.setString(6, null);</span>
<span class="fc" id="L642">						stat.addBatch();</span>
<span class="fc" id="L643">						stat.clearParameters();</span>
					}
				}
<span class="fc" id="L646">			}</span>
<span class="fc" id="L647">			stat.executeBatch();</span>
<span class="nc" id="L648">		} catch (BatchUpdateException e) {</span>
<span class="nc" id="L649">			_logger.error(&quot;Error saving record into contentrelations {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L650">			throw new RuntimeException(&quot;Error saving record into contentrelations &quot; + content.getId(), e.getNextException());</span>
<span class="nc" id="L651">		} catch (Throwable t) {</span>
<span class="nc" id="L652">			_logger.error(&quot;Error saving record into contentrelations {}&quot;, content.getId(), t);</span>
<span class="nc" id="L653">			throw new RuntimeException(&quot;Error saving record into contentrelations &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L655">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L657">	}</span>

	protected void addWorkContentRelationsRecord(Content content, Connection conn) throws EntException {
<span class="fc" id="L660">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L662">			stat = conn.prepareStatement(ADD_WORK_CONTENT_REL_RECORD);</span>
<span class="fc" id="L663">			this.addCategoryRelationsRecord(content, false, stat);</span>
<span class="fc" id="L664">			stat.executeBatch();</span>
<span class="nc" id="L665">		} catch (BatchUpdateException e) {</span>
<span class="nc" id="L666">			_logger.error(&quot;Error saving record into workcontentrelations {}&quot;, content.getId(), e.getNextException());</span>
<span class="nc" id="L667">			throw new RuntimeException(&quot;Error saving record into workcontentrelations &quot; + content.getId(), e);</span>
<span class="nc" id="L668">		} catch (Throwable t) {</span>
<span class="nc" id="L669">			_logger.error(&quot;Error saving record into workcontentrelations {}&quot;, content.getId(), t);</span>
<span class="nc" id="L670">			throw new RuntimeException(&quot;Error saving record into workcontentrelations &quot; + content.getId(), t);</span>
		} finally {
<span class="fc" id="L672">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L674">	}</span>

	protected void addContentAttributeRoleRecord(String id, IApsEntity entity, String query, Connection conn) throws EntException {
<span class="fc" id="L677">		PreparedStatement stat = null;</span>
		try {
<span class="fc" id="L679">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L680">			super.addEntityAttributeRoleRecord(id, entity, stat);</span>
<span class="nc" id="L681">		} catch (Throwable t) {</span>
<span class="nc" id="L682">			_logger.error(&quot;Error on adding content attribute role records&quot;, t);</span>
<span class="nc" id="L683">			throw new RuntimeException(&quot;Error on adding content attribute role records&quot;, t);</span>
		} finally {
<span class="fc" id="L685">			closeDaoResources(null, stat);</span>
		}
<span class="fc" id="L687">	}</span>

	@Override
	public List&lt;String&gt; getContentUtilizers(String contentId) {
<span class="fc" id="L691">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L693">			contentIds = this.getUtilizers(contentId, LOAD_REFERENCED_CONTENTS_FOR_CONTENT);</span>
<span class="nc" id="L694">		} catch (Throwable t) {</span>
<span class="nc" id="L695">			_logger.error(&quot;Error loading referenced contents for content {}&quot;, contentId, t);</span>
<span class="nc" id="L696">			throw new RuntimeException(&quot;Error loading referenced contents for content&quot; + contentId, t);</span>
<span class="fc" id="L697">		}</span>
<span class="fc" id="L698">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getPageUtilizers(String pageCode) {
<span class="fc" id="L703">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L705">			contentIds = this.getUtilizers(pageCode, LOAD_REFERENCED_CONTENTS_FOR_PAGE);</span>
<span class="nc" id="L706">		} catch (Throwable t) {</span>
<span class="nc" id="L707">			_logger.error(&quot;Error loading referenced contents for page {}&quot;, pageCode, t);</span>
<span class="nc" id="L708">			throw new RuntimeException(&quot;Error loading referenced contents for page&quot; + pageCode, t);</span>
<span class="fc" id="L709">		}</span>
<span class="fc" id="L710">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getGroupUtilizers(String groupName) {
<span class="fc" id="L715">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L717">			contentIds = this.getUtilizers(groupName, LOAD_REFERENCED_CONTENTS_FOR_GROUP);</span>
<span class="nc" id="L718">		} catch (Throwable t) {</span>
<span class="nc" id="L719">			_logger.error(&quot;Error loading referenced contents for group {}&quot;, groupName, t);</span>
<span class="nc" id="L720">			throw new RuntimeException(&quot;Error loading referenced contents for group &quot; + groupName, t);</span>
<span class="fc" id="L721">		}</span>
<span class="fc" id="L722">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getResourceUtilizers(String resourceId) {
<span class="fc" id="L727">		List&lt;String&gt; contentIds = null;</span>
		try {
<span class="fc" id="L729">			contentIds = this.getUtilizers(resourceId, LOAD_REFERENCED_CONTENTS_FOR_RESOURCE);</span>
<span class="nc" id="L730">		} catch (Throwable t) {</span>
<span class="nc" id="L731">			_logger.error(&quot;Error loading referenced contents for resource {}&quot;, resourceId, t);</span>
<span class="nc" id="L732">			throw new RuntimeException(&quot;Error loading referenced contents for resource &quot; + resourceId, t);</span>
<span class="fc" id="L733">		}</span>
<span class="fc" id="L734">		return contentIds;</span>
	}

	@Override
	public List&lt;String&gt; getCategoryUtilizers(String categoryCode) {
<span class="fc" id="L739">		Set&lt;String&gt; result = new HashSet&lt;&gt;();</span>
		try {
<span class="fc" id="L741">			result.addAll(this.getUtilizers(categoryCode, LOAD_REFERENCED_CONTENTS_FOR_CATEGORY));</span>
<span class="fc" id="L742">			result.addAll(this.getUtilizers(categoryCode, LOAD_REFERENCED_WORK_CONTENTS_FOR_CATEGORY));</span>
<span class="nc" id="L743">		} catch (Throwable t) {</span>
<span class="nc" id="L744">			_logger.error(&quot;Error loading referenced contents for category {}&quot;, categoryCode, t);</span>
<span class="nc" id="L745">			throw new RuntimeException(&quot;Error loading referenced contents for category &quot; + categoryCode, t);</span>
<span class="fc" id="L746">		}</span>
<span class="fc" id="L747">		return new ArrayList&lt;&gt;(result);</span>
	}

	protected List&lt;String&gt; getUtilizers(String referencedObjectCode, String query) throws Throwable {
<span class="fc" id="L751">		Connection conn = null;</span>
<span class="fc" id="L752">		List&lt;String&gt; contentIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L753">		PreparedStatement stat = null;</span>
<span class="fc" id="L754">		ResultSet res = null;</span>
		try {
<span class="fc" id="L756">			conn = this.getConnection();</span>
<span class="fc" id="L757">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L758">			stat.setString(1, referencedObjectCode);</span>
<span class="fc" id="L759">			res = stat.executeQuery();</span>
<span class="fc bfc" id="L760" title="All 2 branches covered.">			while (res.next()) {</span>
<span class="fc" id="L761">				String id = res.getString(1);</span>
<span class="fc" id="L762">				contentIds.add(id);</span>
<span class="fc" id="L763">			}</span>
<span class="nc" id="L764">		} catch (Throwable t) {</span>
<span class="nc" id="L765">			throw t;</span>
		} finally {
<span class="fc" id="L767">			closeDaoResources(res, stat, conn);</span>
		}
<span class="fc" id="L769">		return contentIds;</span>
	}

	@Override
	public ContentsStatus loadContentStatus() {
<span class="fc" id="L774">		Connection conn = null;</span>
<span class="fc" id="L775">		PreparedStatement stat = null;</span>
<span class="fc" id="L776">		ResultSet res = null;</span>
<span class="fc" id="L777">		ContentsStatus status = null;</span>
		try {
<span class="fc" id="L779">			conn = this.getConnection();</span>
<span class="fc" id="L780">			int online = this.loadContentStatus(conn, COUNT_ONLINE_CONTENTS);</span>
<span class="fc" id="L781">			int offline = this.loadContentStatus(conn, COUNT_OFFLINE_CONTENTS);</span>
<span class="fc" id="L782">			int withDiffs = this.loadContentStatus(conn, COUNT_ONLINE_CONTENTS_WITH_DIFFS);</span>
<span class="fc" id="L783">			Date lastModified = this.loadContentStatusLastModified(conn, LOAD_LAST_MODIFIED_DATE);</span>
<span class="fc" id="L784">			status = new ContentsStatus();</span>
<span class="fc" id="L785">			status.setDraft(offline);</span>
<span class="fc" id="L786">			status.setOnline(online);</span>
<span class="fc" id="L787">			status.setOnlineWithChanges(withDiffs);</span>
<span class="fc" id="L788">			status.setLastUpdate(lastModified);</span>
<span class="nc" id="L789">		} catch (Throwable t) {</span>
<span class="nc" id="L790">			_logger.error(&quot;Error loading contents status&quot;, t);</span>
<span class="nc" id="L791">			throw new RuntimeException(&quot;Error loading contents status&quot;, t);</span>
		} finally {
<span class="fc" id="L793">			closeDaoResources(res, stat, conn);</span>
		}
<span class="fc" id="L795">		return status;</span>
	}

	private int loadContentStatus(Connection conn, String query) {
<span class="fc" id="L799">		PreparedStatement stat = null;</span>
<span class="fc" id="L800">		ResultSet res = null;</span>
<span class="fc" id="L801">		int count = 0;</span>
		try {
<span class="fc" id="L803">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L804">			res = stat.executeQuery();</span>
<span class="pc bpc" id="L805" title="1 of 2 branches missed.">			if (res.next()) {</span>
<span class="fc" id="L806">				count = res.getInt(1);</span>
			}
<span class="nc" id="L808">		} catch (Throwable t) {</span>
<span class="nc" id="L809">            _logger.error(&quot;Error loading contents status &quot;, t);</span>
<span class="nc" id="L810">			throw new RuntimeException(&quot;Error loading contents status&quot;, t);</span>
		} finally {
<span class="fc" id="L812">			closeDaoResources(res, stat);</span>
		}
<span class="fc" id="L814">		return count;</span>
	}

	private Date loadContentStatusLastModified(Connection conn, String query) {
<span class="fc" id="L818">		PreparedStatement stat = null;</span>
<span class="fc" id="L819">		ResultSet res = null;</span>
<span class="fc" id="L820">		Date lastModified = null;</span>
		try {
<span class="fc" id="L822">			stat = conn.prepareStatement(query);</span>
<span class="fc" id="L823">			res = stat.executeQuery();</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">			if (res.next()) {</span>
<span class="fc" id="L825">				String lastMod = res.getString(1);</span>
<span class="fc" id="L826">				lastModified = DateConverter.parseDate(lastMod, SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
			}
<span class="nc" id="L828">		} catch (Throwable t) {</span>
<span class="nc" id="L829">			_logger.error(&quot;Error loading contents status last modified date&quot;, t);</span>
<span class="nc" id="L830">			throw new RuntimeException(&quot;Error loading contents status last modified date&quot;, t);</span>
		} finally {
<span class="fc" id="L832">			closeDaoResources(res, stat);</span>
		}
<span class="fc" id="L834">		return lastModified;</span>
	}

	@Override
	protected String getAddingSearchRecordQuery() {
<span class="fc" id="L839">		return ADD_WORK_CONTENT_SEARCH_RECORD;</span>
	}

	@Override
	protected String getRemovingSearchRecordQuery() {
<span class="fc" id="L844">		return DELETE_WORK_CONTENT_SEARCH_RECORD;</span>
	}

	@Override
	protected String getAddingAttributeRoleRecordQuery() {
<span class="fc" id="L849">		return ADD_WORK_ATTRIBUTE_ROLE_RECORD;</span>
	}

	@Override
	protected String getRemovingAttributeRoleRecordQuery() {
<span class="fc" id="L854">		return DELETE_WORK_ATTRIBUTE_ROLE_RECORD;</span>
	}

	@Override
	protected String getExtractingAllEntityIdQuery() {
<span class="fc" id="L859">		return LOAD_ALL_CONTENTS_ID;</span>
	}

    protected ICategoryManager getCategoryManager() {
<span class="fc" id="L863">        return categoryManager;</span>
    }

    public void setCategoryManager(ICategoryManager categoryManager) {
<span class="fc" id="L867">        this.categoryManager = categoryManager;</span>
<span class="fc" id="L868">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>