<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthorizationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">com.agiletec.aps.system.services.authorization</a> &gt; <span class="el_source">AuthorizationManager.java</span></div><h1>AuthorizationManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package com.agiletec.aps.system.services.authorization;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.agiletec.aps.system.common.AbstractService;
import com.agiletec.aps.system.common.entity.model.IApsEntity;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.group.Group;
import com.agiletec.aps.system.services.group.GroupUtilizer;
import com.agiletec.aps.system.services.group.IGroupManager;
import com.agiletec.aps.system.services.page.IPage;
import com.agiletec.aps.system.services.role.IRoleManager;
import com.agiletec.aps.system.services.role.Permission;
import com.agiletec.aps.system.services.role.Role;
import com.agiletec.aps.system.services.user.UserDetails;
import org.apache.commons.lang3.StringUtils;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.Aspect;
import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;

/**
 * Servizio di autorizzazione. Il servizio espone tutti i metodi necessari per
 * la verifica verifica delle autorizzazioni utente, qualsiasi sia la sua
 * provenienza e definizione.
 * @author E.Santoboni
 */
@Aspect
<span class="nc" id="L48">public class AuthorizationManager extends AbstractService implements IAuthorizationManager, GroupUtilizer {</span>

<span class="nc" id="L50">    private static final EntLogger _logger = EntLogFactory.getSanitizedLogger(AuthorizationManager.class);</span>

    @Override
    public void init() throws Exception {
<span class="nc" id="L54">        _logger.debug(&quot;{} ready&quot;, this.getClass().getName());</span>
<span class="nc" id="L55">    }</span>

    @Override
    @Deprecated
    public boolean isAuth(UserDetails user, IApsAuthority auth) {
<span class="nc" id="L60">        return this.checkAuth(user, auth);</span>
    }

    @Override
    public boolean isAuthOnGroupAndPermission(UserDetails user, String groupName, String permissionName, boolean chechAdmin) {
<span class="nc bnc" id="L65" title="All 6 branches missed.">        if (null == user || null == groupName || null == permissionName) {</span>
<span class="nc" id="L66">            return false;</span>
        }
<span class="nc" id="L68">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="nc" id="L69">        List&lt;Role&gt; rolesWithPermission = this.getRoleManager().getRolesWithPermission(permissionName);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (null != rolesWithPermission) {</span>
<span class="nc" id="L71">            roles.addAll(rolesWithPermission);</span>
        }
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (chechAdmin) {</span>
<span class="nc" id="L74">            List&lt;Role&gt; rolesWithSupPermission = this.getRoleManager().getRolesWithPermission(Permission.SUPERUSER);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (null != rolesWithSupPermission) {</span>
<span class="nc" id="L76">                roles.addAll(rolesWithSupPermission);</span>
            }
        }
<span class="nc bnc" id="L79" title="All 2 branches missed.">        for (int i = 0; i &lt; roles.size(); i++) {</span>
<span class="nc" id="L80">            Role role = roles.get(i);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if (null != role) {</span>
<span class="nc" id="L82">                boolean check = this.isAuthOnGroupAndRole(user, groupName, role.getName(), chechAdmin);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                if (check) {</span>
<span class="nc" id="L84">                    return true;</span>
                }
            }

        }
<span class="nc" id="L89">        return false;</span>
    }

    @Override
    public boolean isAuthOnGroupAndRole(UserDetails user, String groupName, String roleName, boolean chechAdmin) {
<span class="nc bnc" id="L94" title="All 6 branches missed.">        if (null == user || (null == groupName &amp;&amp; null == roleName)) {</span>
<span class="nc" id="L95">            return false;</span>
        }
<span class="nc" id="L97">        List&lt;Authorization&gt; userAuths = user.getAuthorizations();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        for (int i = 0; i &lt; userAuths.size(); i++) {</span>
<span class="nc" id="L99">            Authorization userAuth = userAuths.get(i);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (null == userAuth) {</span>
<span class="nc" id="L101">                continue;</span>
            }
<span class="nc" id="L103">            Group group = userAuth.getGroup();</span>
<span class="nc bnc" id="L104" title="All 8 branches missed.">            if ((null == group &amp;&amp; null != groupName) || (null != group &amp;&amp; null == groupName)) {</span>
<span class="nc" id="L105">                continue;</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">            } else if (null != group &amp;&amp; null != groupName) {</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">                if (!chechAdmin &amp;&amp; !groupName.equals(group.getName())) {</span>
<span class="nc" id="L108">                    continue;</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                } else if (chechAdmin &amp;&amp; !Group.ADMINS_GROUP_NAME.equals(group.getName())) {</span>
<span class="nc" id="L110">                    continue;</span>
                }
            }
<span class="nc" id="L113">            Role role = userAuth.getRole();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (null == roleName) {</span>
<span class="nc" id="L115">                return true;</span>
            } else {
<span class="nc" id="L117">                boolean isSuper = role.hasPermission(Permission.SUPERUSER);</span>
<span class="nc bnc" id="L118" title="All 6 branches missed.">                if (role.getName().equals(roleName) || (chechAdmin &amp;&amp; isSuper)) {</span>
<span class="nc" id="L119">                    return true;</span>
                }
            }
        }
<span class="nc" id="L123">        return false;</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getRelatedAuthorities(UserDetails user, IApsAuthority auth) {
<span class="nc bnc" id="L128" title="All 4 branches missed.">        if (null == user || null == auth) {</span>
<span class="nc" id="L129">            return null;</span>
        }
<span class="nc" id="L131">        String requiredAuthName = auth.getAuthority();</span>
<span class="nc" id="L132">        boolean isRole = (auth instanceof Role);</span>
<span class="nc" id="L133">        return (List&lt;IApsAuthority&gt;) this.getRelatedAuthorities(user, requiredAuthName, isRole);</span>
    }

    private List getRelatedAuthorities(UserDetails user, String requiredAuthName, boolean isRole) {
<span class="nc bnc" id="L137" title="All 12 branches missed.">        if (null == user || null == requiredAuthName || (isRole &amp;&amp; null == this.getRoleManager().getRole(requiredAuthName)) || (!isRole &amp;&amp; null == this.getGroupManager().getGroup(requiredAuthName))) {</span>
<span class="nc" id="L138">            return null;</span>
        }

<span class="nc" id="L141">        List&lt;String&gt; adminRoleNames = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (isRole) {</span>
<span class="nc" id="L143">            List&lt;Role&gt; adminRoles = this.getRolesWithPermission(user, Permission.SUPERUSER);</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">            if (null != adminRoles &amp;&amp; !adminRoles.isEmpty()) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                for (int i = 0; i &lt; adminRoles.size(); i++) {</span>
<span class="nc" id="L146">                    Role role = adminRoles.get(i);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                    if (null != role) {</span>
<span class="nc" id="L148">                        adminRoleNames.add(role.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L153">        List authorities = new ArrayList&lt;IApsAuthority&gt;();</span>
<span class="nc" id="L154">        List&lt;Authorization&gt; userAuths = user.getAuthorizations();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (int i = 0; i &lt; userAuths.size(); i++) {</span>
<span class="nc" id="L156">            Authorization userAuth = userAuths.get(i);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (null == userAuth) {</span>
<span class="nc" id="L158">                continue;</span>
            }
<span class="nc bnc" id="L160" title="All 8 branches missed.">            if (!isRole &amp;&amp; null != userAuth.getGroup() &amp;&amp; (userAuth.getGroup().getName().equals(Group.ADMINS_GROUP_NAME) || requiredAuthName.equals(userAuth.getGroup().getAuthority()))) {</span>
<span class="nc" id="L161">                authorities.add(userAuth.getRole());</span>
            }
<span class="nc bnc" id="L163" title="All 8 branches missed.">            if (isRole &amp;&amp; null != userAuth.getRole() &amp;&amp; (adminRoleNames.contains(userAuth.getRole().getName()) || requiredAuthName.equals(userAuth.getRole().getAuthority()))) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (userAuth.getGroup().getName().equals(Group.ADMINS_GROUP_NAME)) {</span>
<span class="nc" id="L165">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="nc" id="L167">                    authorities.add(userAuth.getGroup());</span>
                }
            }
        }
<span class="nc" id="L171">        return authorities;</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Group group) {
<span class="nc" id="L176">        return this.isAuthOnGroup(user, group.getName());</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByGroup(UserDetails user, Group group) {
<span class="nc" id="L181">        return this.getRelatedAuthorities(user, group);</span>
    }

    @Override
    public List&lt;Role&gt; getRolesByGroup(UserDetails user, Group group) {
<span class="nc" id="L186">        return this.getRelatedAuthorities(user, group.getName(), false);</span>
    }

    @Override
    public boolean isAuth(UserDetails user, IApsEntity entity) {
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (null == entity || null == user) {</span>
<span class="nc" id="L192">            return false;</span>
        }
<span class="nc" id="L194">        String mainGroupName = entity.getMainGroup();</span>
<span class="nc bnc" id="L195" title="All 6 branches missed.">        if (mainGroupName.equals(Group.FREE_GROUP_NAME) || this.checkAuth(user, mainGroupName, false) || this.checkAuth(user, Group.ADMINS_GROUP_NAME, false)) {</span>
<span class="nc" id="L196">            return true;</span>
        }
<span class="nc" id="L198">        Set&lt;String&gt; groups = entity.getGroups();</span>
<span class="nc" id="L199">        return isAuth(user, groups);</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Set&lt;String&gt; groups) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L205">            return false;</span>
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (this.checkAuth(user, Group.ADMINS_GROUP_NAME, false)) {</span>
<span class="nc" id="L208">            return true;</span>
        }
<span class="nc bnc" id="L210" title="All 4 branches missed.">        if (null == groups || groups.isEmpty()) {</span>
<span class="nc" id="L211">            return false;</span>
        }
<span class="nc" id="L213">        Iterator&lt;String&gt; iter = groups.iterator();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        while (iter.hasNext()) {</span>
<span class="nc" id="L215">            String groupName = iter.next();</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">            if (groupName.equals(Group.FREE_GROUP_NAME) || this.checkAuth(user, groupName, false)) {</span>
<span class="nc" id="L217">                return true;</span>
            }
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">        return false;</span>
    }

    @Override
    public boolean isAuth(UserDetails user, Permission permission) {
<span class="nc" id="L225">        return this.isAuthOnPermission(user, permission.getName());</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByPermission(UserDetails user, Permission permission) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (null == permission) {</span>
<span class="nc" id="L231">            return null;</span>
        }
<span class="nc" id="L233">        return this.getAuthoritiesByPermissionName(user, permission.getName());</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByPermission(UserDetails user, Permission permission) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (null == permission) {</span>
<span class="nc" id="L239">            return null;</span>
        }
<span class="nc" id="L241">        return this.getGroupsByPermission(user, permission.getName());</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByPermission(UserDetails user, String permissionName) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L247">            return null;</span>
        }
<span class="nc" id="L249">        List&lt;Group&gt; groups = new ArrayList&lt;Group&gt;();</span>
<span class="nc" id="L250">        List&lt;IApsAuthority&gt; auths = this.getAuthoritiesByPermissionName(user, permissionName);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L252">            IApsAuthority auth = auths.get(i);</span>
<span class="nc bnc" id="L253" title="All 4 branches missed.">            if (null != auth &amp;&amp; auth instanceof Group) {</span>
<span class="nc" id="L254">                String groupName = auth.getAuthority();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (Group.ADMINS_GROUP_NAME.equals(groupName)) {</span>
<span class="nc" id="L256">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    if (!groups.contains((Group) auth)) {</span>
<span class="nc" id="L259">                        groups.add((Group) auth);</span>
                    }
                }
            }
        }
<span class="nc" id="L264">        return groups;</span>
    }

    private List getAuthoritiesByPermissionName(UserDetails user, String permissionName) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L269">            return null;</span>
        }
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (null == permissionName) {</span>
<span class="nc" id="L272">            return null;</span>
        }
<span class="nc" id="L274">        List auths = new ArrayList();</span>
<span class="nc" id="L275">        this.addAuthoritiesByPermissionName(user, permissionName, auths);</span>
<span class="nc" id="L276">        this.addAuthoritiesByPermissionName(user, Permission.SUPERUSER, auths);</span>
<span class="nc" id="L277">        return auths;</span>
    }

    private void addAuthoritiesByPermissionName(UserDetails user, String permissionName, List auths) {
<span class="nc" id="L281">        List&lt;Role&gt; roles = this.getRolesWithPermission(user, permissionName);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        for (int i = 0; i &lt; roles.size(); i++) {</span>
<span class="nc" id="L283">            Role role = roles.get(i);</span>
<span class="nc" id="L284">            List groupAuths = this.getRelatedAuthorities(user, role);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (null != groupAuths) {</span>
<span class="nc" id="L286">                auths.addAll(groupAuths);</span>
            }
        }
<span class="nc" id="L289">    }</span>

    @Override
    public boolean isAuth(UserDetails user, IPage page) {
<span class="nc" id="L293">        return isAuth(user, page, true);</span>
    }

    @Override
    public boolean isAuth(UserDetails user, IPage page, boolean allowFreeGroup) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L299">            return false;</span>
        }
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (this.isAuthOnGroup(user, Group.ADMINS_GROUP_NAME)) {</span>
<span class="nc" id="L302">            return true;</span>
        }
<span class="nc" id="L304">        String pageGroup = page.getGroup();</span>
<span class="nc bnc" id="L305" title="All 4 branches missed.">        if (allowFreeGroup &amp;&amp; Group.FREE_GROUP_NAME.equals(pageGroup)) {</span>
<span class="nc" id="L306">            return true;</span>
        }
<span class="nc" id="L308">        boolean isAuthorized = this.isAuthOnGroup(user, pageGroup);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (isAuthorized) {</span>
<span class="nc" id="L310">            return true;</span>
        }
<span class="nc" id="L312">        Collection&lt;String&gt; extraGroups = page.getExtraGroups();</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">        if (null != extraGroups &amp;&amp; !extraGroups.isEmpty()) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">            if (extraGroups.contains(Group.FREE_GROUP_NAME)) {</span>
<span class="nc" id="L315">                return true;</span>
            }
<span class="nc" id="L317">            Iterator&lt;String&gt; iter = extraGroups.iterator();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L319">                String extraGroupName = iter.next();</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (this.isAuthOnGroup(user, extraGroupName)) {</span>
<span class="nc" id="L321">                    return true;</span>
                }
<span class="nc" id="L323">            }</span>
        }
<span class="nc" id="L325">        return false;</span>
    }

    @Override
    public boolean isAuthOnGroup(UserDetails user, String groupName) {
<span class="nc bnc" id="L330" title="All 4 branches missed.">        return ((this.checkAuth(user, groupName, false) || this.checkAuth(user, Group.ADMINS_GROUP_NAME, false)));</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByGroup(UserDetails user, String groupName) {
<span class="nc" id="L335">        return this.getRelatedAuthorities(user, groupName, false);</span>
    }

    @Override
    public List&lt;Role&gt; getRolesByGroup(UserDetails user, String groupName) {
<span class="nc" id="L340">        return this.getRelatedAuthorities(user, groupName, false);</span>
    }

    @Override
    public boolean isAuthOnRole(UserDetails user, String roleName) {
<span class="nc bnc" id="L345" title="All 4 branches missed.">        return ((this.isAuthOnPermission(user, Permission.SUPERUSER) || this.checkAuth(user, roleName, true)));</span>
    }

    @Override
    public List&lt;IApsAuthority&gt; getAuthoritiesByRole(UserDetails user, String roleName) {
<span class="nc" id="L350">        return this.getRelatedAuthorities(user, roleName, true);</span>
    }

    @Override
    public List&lt;Group&gt; getGroupsByRole(UserDetails user, String roleName) {
<span class="nc" id="L355">        return this.getRelatedAuthorities(user, roleName, true);</span>
    }

    @Override
    public boolean isAuthOnPermission(UserDetails user, String permissionName) {
<span class="nc" id="L360">        boolean check = this.isAuthOnSinglePermission(user, permissionName);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (check) {</span>
<span class="nc" id="L362">            return true;</span>
        }
<span class="nc" id="L364">        return this.isAuthOnSinglePermission(user, Permission.SUPERUSER);</span>
    }

    private boolean isAuthOnSinglePermission(UserDetails user, String permissionName) {
<span class="nc bnc" id="L368" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L369">            return false;</span>
        }
<span class="nc" id="L371">        List&lt;Role&gt; rolesWithPermission = this.getRolesWithPermission(user, permissionName);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        for (int i = 0; i &lt; rolesWithPermission.size(); i++) {</span>
<span class="nc" id="L373">            Role role = rolesWithPermission.get(i);</span>
<span class="nc" id="L374">            boolean check = this.checkAuth(user, role.getAuthority(), true);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if (check) {</span>
<span class="nc" id="L376">                return true;</span>
            }
        }
<span class="nc" id="L379">        return false;</span>
    }

    private List&lt;Role&gt; getRolesWithPermission(UserDetails user, String permissionName) {
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L384">            return null;</span>
        }
<span class="nc" id="L386">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="nc" id="L387">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L389">            Authorization auth = auths.get(i);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (null == auth) {</span>
<span class="nc" id="L391">                continue;</span>
            }
<span class="nc bnc" id="L393" title="All 4 branches missed.">            if (null != auth.getRole() &amp;&amp; auth.getRole().hasPermission(permissionName)) {</span>
<span class="nc" id="L394">                roles.add(auth.getRole());</span>
            }
        }
<span class="nc" id="L397">        return roles;</span>
    }

    @Override
    @Deprecated
    public List&lt;Group&gt; getGroupsOfUser(UserDetails user) {
<span class="nc" id="L403">        return this.getUserGroups(user);</span>
    }

    @Override
    public List&lt;Group&gt; getUserGroups(UserDetails user) {
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L409">            return null;</span>
        }
<span class="nc" id="L411">        List&lt;Group&gt; groups = new ArrayList&lt;Group&gt;();</span>
<span class="nc" id="L412">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L414">            Authorization auth = auths.get(i);</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if (null != auth &amp;&amp; null != auth.getGroup()) {</span>
<span class="nc" id="L416">                String groupName = auth.getGroup().getName();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                if (Group.ADMINS_GROUP_NAME.equals(groupName)) {</span>
<span class="nc" id="L418">                    return this.getGroupManager().getGroups();</span>
                } else {
<span class="nc" id="L420">                    groups.add(auth.getGroup());</span>
                }
            }
        }
<span class="nc" id="L424">        return groups;</span>
    }

    @Override
    public List&lt;Role&gt; getUserRoles(UserDetails user) {
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (null == user) {</span>
<span class="nc" id="L430">            return null;</span>
        }
<span class="nc" id="L432">        List&lt;Role&gt; roles = new ArrayList&lt;Role&gt;();</span>
<span class="nc" id="L433">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L435">            Authorization auth = auths.get(i);</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">            if (null != auth &amp;&amp; null != auth.getRole()) {</span>
<span class="nc" id="L437">                roles.add(auth.getRole());</span>
            }
        }
<span class="nc" id="L440">        return roles;</span>
    }

    @Deprecated
    private boolean checkAuth(UserDetails user, IApsAuthority requiredAuth) {
<span class="nc bnc" id="L445" title="All 4 branches missed.">        if (null == requiredAuth || null == user) {</span>
<span class="nc" id="L446">            return false;</span>
        }
<span class="nc" id="L448">        boolean isRole = (requiredAuth instanceof Role);</span>
<span class="nc" id="L449">        String requiredAuthName = requiredAuth.getAuthority();</span>
<span class="nc" id="L450">        return this.checkAuth(user, requiredAuthName, isRole);</span>
    }

    private boolean checkAuth(UserDetails user, String requiredAuthName, boolean isRole) {
<span class="nc bnc" id="L454" title="All 4 branches missed.">        if (null == requiredAuthName || null == user) {</span>
<span class="nc" id="L455">            return false;</span>
        }
<span class="nc" id="L457">        List&lt;Authorization&gt; auths = user.getAuthorizations();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        for (int i = 0; i &lt; auths.size(); i++) {</span>
<span class="nc" id="L459">            Authorization auth = auths.get(i);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (null == auth) {</span>
<span class="nc" id="L461">                continue;</span>
            }
<span class="nc bnc" id="L463" title="All 6 branches missed.">            if (isRole &amp;&amp; null != auth.getRole() &amp;&amp; requiredAuthName.equals(auth.getRole().getAuthority())) {</span>
<span class="nc" id="L464">                return true;</span>
            }
<span class="nc bnc" id="L466" title="All 6 branches missed.">            if (!isRole &amp;&amp; null != auth.getGroup() &amp;&amp; requiredAuthName.equals(auth.getGroup().getAuthority())) {</span>
<span class="nc" id="L467">                return true;</span>
            }
        }
<span class="nc" id="L470">        return false;</span>
    }

    @Override
    public List&lt;Authorization&gt; getUserAuthorizations(String username) throws EntException {
<span class="nc" id="L475">        List&lt;Authorization&gt; authorizations = null;</span>
        try {
<span class="nc" id="L477">            Map&lt;String, Group&gt; groups = (Map&lt;String, Group&gt;) this.getAuthorityMap(this.getGroupManager().getGroups());</span>
<span class="nc" id="L478">            Map&lt;String, Role&gt; roles = (Map&lt;String, Role&gt;) this.getAuthorityMap(this.getRoleManager().getRoles());</span>
<span class="nc" id="L479">            authorizations = this.getAuthorizationDAO().getUserAuthorizations(username, groups, roles);</span>
<span class="nc" id="L480">        } catch (Throwable t) {</span>
<span class="nc" id="L481">            _logger.error(&quot;Error extracting user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L482">            throw new EntException(&quot;Error extracting user authorizations for user &quot; + username, t);</span>
<span class="nc" id="L483">        }</span>
<span class="nc" id="L484">        return authorizations;</span>
    }

    private Map getAuthorityMap(List list) {
<span class="nc" id="L488">        Map&lt;String, IApsAuthority&gt; map = new HashMap&lt;String, IApsAuthority&gt;();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L490">            IApsAuthority authority = (IApsAuthority) list.get(i);</span>
<span class="nc" id="L491">            map.put(authority.getAuthority(), authority);</span>
        }
<span class="nc" id="L493">        return map;</span>
    }

    @Override
    public void addUserAuthorization(String username, String groupName, String roleName) throws EntException {
        try {
<span class="nc bnc" id="L499" title="All 2 branches missed.">            Group group = (null != groupName) ? this.getGroupManager().getGroup(groupName) : null;</span>
<span class="nc bnc" id="L500" title="All 4 branches missed.">            if (null != groupName &amp;&amp; null == group) {</span>
<span class="nc" id="L501">                _logger.warn(&quot;invalid authorization -  invalid referenced group name&quot;);</span>
<span class="nc" id="L502">                return;</span>
            }
<span class="nc bnc" id="L504" title="All 2 branches missed.">            Role role = (null != roleName) ? this.getRoleManager().getRole(roleName) : null;</span>
<span class="nc bnc" id="L505" title="All 4 branches missed.">            if (null != roleName &amp;&amp; null == role) {</span>
<span class="nc" id="L506">                _logger.warn(&quot;invalid authorization -  invalid referenced role name&quot;);</span>
<span class="nc" id="L507">                return;</span>
            }
<span class="nc" id="L509">            Authorization authorization = new Authorization(group, role);</span>
<span class="nc" id="L510">            this.addUserAuthorization(username, authorization);</span>
<span class="nc" id="L511">        } catch (Throwable t) {</span>
<span class="nc" id="L512">            _logger.error(&quot;Error adding user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L513">            throw new EntException(&quot;Error adding user authorization for user &quot; + username, t);</span>
<span class="nc" id="L514">        }</span>
<span class="nc" id="L515">    }</span>

    @Override
    public void addUserAuthorization(String username, Authorization authorization) throws EntException {
<span class="nc bnc" id="L519" title="All 4 branches missed.">        if (null == username || null == authorization) {</span>
<span class="nc" id="L520">            return;</span>
        }
        try {
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (this.checkAuthorization(authorization)) {</span>
<span class="nc" id="L524">                this.getAuthorizationDAO().addUserAuthorization(username, authorization);</span>
            }
<span class="nc" id="L526">        } catch (Throwable t) {</span>
<span class="nc" id="L527">            _logger.error(&quot;Error adding user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L528">            throw new EntException(&quot;Error adding user authorization for user &quot; + username, t);</span>
<span class="nc" id="L529">        }</span>
<span class="nc" id="L530">    }</span>

    @Override
    public void addUserAuthorizations(String username, List&lt;Authorization&gt; authorizations) throws EntException {
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (null == username) {</span>
<span class="nc" id="L535">            return;</span>
        }
        try {
<span class="nc" id="L538">            List&lt;Authorization&gt; toAdd = this.checkAuthorizations(authorizations);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (null == toAdd) {</span>
<span class="nc" id="L540">                return;</span>
            }
<span class="nc" id="L542">            this.getAuthorizationDAO().addUserAuthorizations(username, toAdd);</span>
<span class="nc" id="L543">        } catch (Throwable t) {</span>
<span class="nc" id="L544">            _logger.error(&quot;Error adding user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L545">            throw new EntException(&quot;Error adding user authorizations for user &quot; + username, t);</span>
<span class="nc" id="L546">        }</span>
<span class="nc" id="L547">    }</span>

    @Override
    public void updateUserAuthorizations(String username, List&lt;Authorization&gt; authorizations) throws EntException {
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (null == username) {</span>
<span class="nc" id="L552">            return;</span>
        }
        try {
<span class="nc" id="L555">            List&lt;Authorization&gt; toSet = this.checkAuthorizations(authorizations);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            if (null == toSet) {</span>
<span class="nc" id="L557">                return;</span>
            }
<span class="nc" id="L559">            this.getAuthorizationDAO().updateUserAuthorizations(username, toSet);</span>
<span class="nc" id="L560">        } catch (Throwable t) {</span>
<span class="nc" id="L561">            _logger.error(&quot;Error updating user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L562">            throw new EntException(&quot;Error updating user authorizations for user &quot; + username, t);</span>
<span class="nc" id="L563">        }</span>
<span class="nc" id="L564">    }</span>

    private List&lt;Authorization&gt; checkAuthorizations(List&lt;Authorization&gt; authorizations) throws Throwable {
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (null == authorizations) {</span>
<span class="nc" id="L568">            return null;</span>
        }
<span class="nc" id="L570">        List&lt;Authorization&gt; checked = new ArrayList&lt;Authorization&gt;();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        for (int i = 0; i &lt; authorizations.size(); i++) {</span>
<span class="nc" id="L572">            Authorization authorization = authorizations.get(i);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (this.checkAuthorization(authorization)) {</span>
<span class="nc" id="L574">                checked.add(authorization);</span>
            }
        }
<span class="nc" id="L577">        return checked;</span>
    }

    private boolean checkAuthorization(Authorization authorization) throws Throwable {
<span class="nc bnc" id="L581" title="All 2 branches missed.">        if (null == authorization) {</span>
<span class="nc" id="L582">            _logger.warn(&quot;invalid authorization -  null object&quot;);</span>
<span class="nc" id="L583">            return false;</span>
        }
<span class="nc bnc" id="L585" title="All 2 branches missed.">        String groupName = (null != authorization.getGroup()) ? authorization.getGroup().getName() : null;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">        String roleName = (null != authorization.getRole()) ? authorization.getRole().getName() : null;</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">        if (null == roleName &amp;&amp; null == groupName) {</span>
<span class="nc" id="L588">            _logger.warn(&quot;invalid authorization -  null group and role&quot;);</span>
<span class="nc" id="L589">            return false;</span>
        }
<span class="nc bnc" id="L591" title="All 4 branches missed.">        if (null != groupName &amp;&amp; null == this.getGroupManager().getGroup(groupName)) {</span>
<span class="nc" id="L592">            _logger.warn(&quot;invalid authorization -  invalid referenced group&quot;);</span>
<span class="nc" id="L593">            return false;</span>
        }
<span class="nc bnc" id="L595" title="All 4 branches missed.">        if (null != roleName &amp;&amp; null == this.getRoleManager().getRole(roleName)) {</span>
<span class="nc" id="L596">            _logger.warn(&quot;invalid authorization -  invalid referenced role&quot;);</span>
<span class="nc" id="L597">            return false;</span>
        }
<span class="nc" id="L599">        return true;</span>
    }

    @Override
    public void deleteUserAuthorization(String username, String groupname, String rolename) throws EntException {
        try {
<span class="nc" id="L605">            this.getAuthorizationDAO().deleteUserAuthorization(username, groupname, rolename);</span>
<span class="nc" id="L606">        } catch (Throwable t) {</span>
<span class="nc" id="L607">            _logger.error(&quot;Error deleting user authorization for user '{}'&quot;, username, t);</span>
<span class="nc" id="L608">            throw new EntException(&quot;Error deleting user authorization for user &quot; + username, t);</span>
<span class="nc" id="L609">        }</span>
<span class="nc" id="L610">    }</span>

    @Override
    public void deleteUserAuthorizations(String username) throws EntException {
        try {
<span class="nc" id="L615">            this.getAuthorizationDAO().deleteUserAuthorizations(username);</span>
<span class="nc" id="L616">        } catch (Throwable t) {</span>
<span class="nc" id="L617">            _logger.error(&quot;Error deleting user authorizations for user '{}'&quot;, username, t);</span>
<span class="nc" id="L618">            throw new EntException(&quot;Error deleting user authorizations for user &quot; + username, t);</span>
<span class="nc" id="L619">        }</span>
<span class="nc" id="L620">    }</span>

    @AfterReturning(pointcut = &quot;execution(* com.agiletec.aps.system.services.user.IUserManager.removeUser(..)) &amp;&amp; args(key)&quot;)
    public void deleteUser(Object key) {
<span class="nc" id="L624">        String username = null;</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (key instanceof String) {</span>
<span class="nc" id="L626">            username = key.toString();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">        } else if (key instanceof UserDetails) {</span>
<span class="nc" id="L628">            UserDetails userDetails = (UserDetails) key;</span>
<span class="nc" id="L629">            username = userDetails.getUsername();</span>
        }
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if (username != null) {</span>
            try {
<span class="nc" id="L633">                this.deleteUserAuthorizations(username);</span>
<span class="nc" id="L634">            } catch (Throwable t) {</span>
<span class="nc" id="L635">                _logger.error(&quot;Error deleting user authorizations. user: {}&quot;, username, t);</span>
<span class="nc" id="L636">            }</span>
        }
<span class="nc" id="L638">    }</span>

    @Override
    public List&lt;String&gt; getUsersByRole(IApsAuthority authority, boolean includeAdmin) throws EntException {
<span class="nc bnc" id="L642" title="All 6 branches missed.">        if (null == authority || !(authority instanceof Role) || null == this.getRoleManager().getRole(authority.getAuthority())) {</span>
<span class="nc" id="L643">            return null;</span>
        }
<span class="nc" id="L645">        return this.getUsersByAuthorities(null, authority.getAuthority(), includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByRole(String roleName, boolean includeAdmin) throws EntException {
<span class="nc" id="L650">        Role role = this.getRoleManager().getRole(roleName);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (null == role) {</span>
<span class="nc" id="L652">            return null;</span>
        }
<span class="nc" id="L654">        return this.getUsersByAuthorities(null, roleName, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByGroup(IApsAuthority authority, boolean includeAdmin) throws EntException {
<span class="nc bnc" id="L659" title="All 6 branches missed.">        if (null == authority || !(authority instanceof Group) || null == this.getGroupManager().getGroup(authority.getAuthority())) {</span>
<span class="nc" id="L660">            return null;</span>
        }
<span class="nc" id="L662">        return this.getUsersByAuthorities(authority.getAuthority(), null, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByGroup(String groupName, boolean includeAdmin) throws EntException {
<span class="nc" id="L667">        Group group = this.getGroupManager().getGroup(groupName);</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (null == group) {</span>
<span class="nc" id="L669">            return null;</span>
        }
<span class="nc" id="L671">        return this.getUsersByAuthorities(groupName, null, includeAdmin);</span>
    }

    @Override
    public List&lt;String&gt; getUsersByAuthorities(String groupName, String roleName, boolean includeAdmin) throws EntException {
<span class="nc" id="L676">        List&lt;String&gt; usernames = null;</span>
        try {
<span class="nc" id="L678">            List&lt;String&gt; groupNames = null;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            if (!StringUtils.isEmpty(groupName)) {</span>
<span class="nc" id="L680">                groupNames = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L681">                groupNames.add(groupName);</span>
<span class="nc bnc" id="L682" title="All 4 branches missed.">                if (includeAdmin &amp;&amp; !groupName.equals(Group.ADMINS_GROUP_NAME)) {</span>
<span class="nc" id="L683">                    groupNames.add(Group.ADMINS_GROUP_NAME);</span>
                }
            }
<span class="nc" id="L686">            List&lt;String&gt; roleNames = null;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (!StringUtils.isEmpty(roleName)) {</span>
<span class="nc" id="L688">                roleNames = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L689">                roleNames.add(roleName);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                if (includeAdmin) {</span>
<span class="nc" id="L691">                    List&lt;Role&gt; adminRoles = this.getRoleManager().getRolesWithPermission(Permission.SUPERUSER);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">                    if (null != adminRoles) {</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                        for (int i = 0; i &lt; adminRoles.size(); i++) {</span>
<span class="nc" id="L694">                            Role role = adminRoles.get(i);</span>
<span class="nc bnc" id="L695" title="All 4 branches missed.">                            if (null != role &amp;&amp; !roleNames.contains(role.getName())) {</span>
<span class="nc" id="L696">                                roleNames.add(role.getName());</span>
                            }
                        }
                    }
                }
            }
<span class="nc" id="L702">            usernames = this.getAuthorizationDAO().getUsersByAuthorities(groupNames, roleNames);</span>
<span class="nc" id="L703">        } catch (Throwable t) {</span>
<span class="nc" id="L704">            _logger.error(&quot;Error extracting usernames by authorities - group '{}' : role {}&quot;, groupName, roleName, t);</span>
<span class="nc" id="L705">            throw new EntException(&quot;Error extracting usernames by authorities&quot;, t);</span>
<span class="nc" id="L706">        }</span>
<span class="nc" id="L707">        return usernames;</span>
    }

    @Override
    public List&lt;String&gt; getUsersByAuthority(IApsAuthority authority, boolean includeAdmin) throws EntException {
<span class="nc bnc" id="L712" title="All 2 branches missed.">        if (authority instanceof Group) {</span>
<span class="nc" id="L713">            return this.getUsersByGroup(authority, includeAdmin);</span>
        } else {
<span class="nc" id="L715">            return this.getUsersByRole(authority, includeAdmin);</span>
        }
    }

	@Override
    public List&lt;String&gt; getGroupUtilizers(String groupName) throws EntException {
<span class="nc" id="L721">		return this.getUsersByGroup(groupName, false);</span>
	}

    protected IAuthorizationDAO getAuthorizationDAO() {
<span class="nc" id="L725">        return _authorizationDAO;</span>
    }

    public void setAuthorizationDAO(IAuthorizationDAO authorizationDAO) {
<span class="nc" id="L729">        this._authorizationDAO = authorizationDAO;</span>
<span class="nc" id="L730">    }</span>

    protected IRoleManager getRoleManager() {
<span class="nc" id="L733">        return _roleManager;</span>
    }

    public void setRoleManager(IRoleManager roleManager) {
<span class="nc" id="L737">        this._roleManager = roleManager;</span>
<span class="nc" id="L738">    }</span>

    protected IGroupManager getGroupManager() {
<span class="nc" id="L741">        return _groupManager;</span>
    }

    public void setGroupManager(IGroupManager groupManager) {
<span class="nc" id="L745">        this._groupManager = groupManager;</span>
<span class="nc" id="L746">    }</span>

    private IAuthorizationDAO _authorizationDAO;
    private IRoleManager _roleManager;
    private IGroupManager _groupManager;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>